# 秘书聊天智能回复与敏感词过滤系统

## 问题背景

### 修复前的问题
1. **回复牛头不对马嘴**：秘书回复逻辑过于简单，只做简单关键词匹配，导致答非所问
   - 示例：玩家问"你好吗" → 秘书回复"记得按时吃饭哦，老板！"（完全不相关）
   - 示例：玩家输入"习近平" → 秘书回复"没问题！"（应该拦截敏感词）

2. **缺少敏感词过滤**：没有任何内容审核机制，政治敏感词汇可以随意输入

## 解决方案

### 1. 完整的敏感词过滤系统

#### 敏感词分类
- **国家领导人和政治人物（中国）**：
  - 现任：习近平、李强、赵乐际、王沪宁、蔡奇、丁薛祥、李希等
  - 历任：毛泽东、邓小平、江泽民、胡锦涛、周恩来、朱镕基、温家宝、李克强等
  - 职位：主席、总书记、总理、政治局、常委

- **国际政治人物**：
  - 特朗普、拜登、普京、金正恩、文在寅、岸田文雄
  - 马克龙、默克尔、约翰逊、奥巴马、克林顿、布什

- **敏感政治词汇**：
  - 党派：共产党、国民党、民进党、法轮功
  - 事件：六四、天安门
  - 分裂：台独、藏独、疆独、港独
  - 敏感词：民主、自由、人权、政变、革命、起义、暴动、游行、示威

#### 检测机制
```kotlin
fun containsSensitiveWords(message: String): Boolean {
    return sensitiveWords.any { sensitive ->
        message.contains(sensitive, ignoreCase = true)
    }
}
```

#### 拦截提示
当检测到敏感词时，秘书会回复：
> ⚠️ 检测到敏感词，请不要讨论政治相关话题哦，老板！

### 2. 智能回复系统重构

#### 多层次匹配策略

**优先级排序**：
1. 敏感词检测（最高优先级）
2. 空消息处理
3. 语义模式匹配（按优先级）：
   - 问候类
   - 询问状态类
   - 感谢类
   - 赞美类
   - 工作相关类
   - 关心类
   - 情感类
4. 特殊标点符号处理
5. 兜底回复（避免答非所问）

#### 具体分类示例

**1. 问候类**
- 关键词：`你好`、`您好`、`hi`、`hello`
- 回复：`"您好，老板！有什么需要我帮忙的吗？"`

- 关键词：`早上好`、`早安`、`早`
- 回复：`"早上好，老板！新的一天，让我们一起加油！"`

**2. 询问状态类**（精确匹配避免误判）
- 关键词：`你好吗`、`怎么样`、`最近如何`
- 回复：`"我很好，谢谢老板关心！您呢？"`

- 关键词：`在吗`、`在不在`
- 回复：`"在的，老板！有什么吩咐？"`

**3. 感谢类**
- 关键词：`谢谢`、`感谢`、`辛苦了`
- 回复：`"不客气，老板！这是我应该做的。"`

**4. 赞美类**
- 关键词：`漂亮`、`美女`、`好看`
- 回复：`"谢谢夸奖，老板！💕"`

- 关键词：`聪明`、`厉害`、`能干`
- 回复：`"这都是跟老板您学的！"`

**5. 工作相关类**
- 关键词：`公司`、`企业`
- 回复：`"咱们公司正在蓬勃发展中！"`

- 关键词：`游戏`、`项目`
- 回复：`"游戏开发进展顺利，老板！"`

- 关键词：`资金`、`钱`、`收益`
- 回复：`"让我查看一下财务数据..."`

**6. 关心类**
- 关键词：`吃饭`、`饿`
- 回复：`"记得按时吃饭哦，老板！"`

- 关键词：`休息`、`累`、`困`
- 回复：`"注意劳逸结合哦，老板！"`

**7. 情感类**
- 关键词：`喜欢`、`爱`
- 回复：`"我也很喜欢为您工作！"`

- 关键词：`哈哈`、`笑`
- 回复：`"看到老板开心我也很高兴！😊"`

**8. 兜底回复**（避免答非所问）
当所有模式都无法匹配时：
- `"老板，您说什么？我没太听懂..."`
- `"抱歉，我不太理解您的意思，能再说清楚一点吗？"`
- `"嗯...这个问题我需要想一想..."`
- `"您能详细说明一下吗？"`
- `"我好像不太明白，您是在询问工作上的事情吗？"`

#### 特殊符号处理
- **问号（?、？）**：返回询问相关的回复
  - `"这个问题让我想想..."`
  - `"关于这个问题，我建议您查看相关数据！"`
  
- **感叹号（!、！）**：返回积极肯定的回复
  - `"是的！"`
  - `"太好了！"`

## 技术实现

### 核心文件
- `ChatMessage.kt`：SecretaryReplyManager 智能回复管理器
- `SecretaryChatDialog.kt`：对话框界面，发送前敏感词检测
- `SecretaryChatScreen.kt`：全屏界面，发送前敏感词检测

### 关键函数

#### containsSensitiveWords()
```kotlin
fun containsSensitiveWords(message: String): Boolean {
    return sensitiveWords.any { sensitive ->
        message.contains(sensitive, ignoreCase = true)
    }
}
```

#### generateReply()
```kotlin
fun generateReply(playerMessage: String): String {
    val message = playerMessage.trim()
    
    // 1. 敏感词检测
    if (containsSensitiveWords(message)) {
        return "⚠️ 检测到敏感词，请不要讨论政治相关话题哦，老板！"
    }
    
    // 2. 空消息处理
    if (message.isEmpty()) {
        return "老板，您想说什么呢？"
    }
    
    // 3. 多层次模式匹配
    for (patterns in allPatterns) {
        for ((keywords, replies) in patterns) {
            if (keywords.any { keyword -> message.contains(keyword, ignoreCase = true) }) {
                return replies.random()
            }
        }
    }
    
    // 4. 特殊符号处理
    when {
        message.contains("?") || message.contains("？") -> { ... }
        message.contains("!") || message.contains("！") -> { ... }
    }
    
    // 5. 兜底回复
    return fallbackReplies.random()
}
```

### UI层面拦截
在发送按钮的点击事件中，先进行敏感词检测：
```kotlin
onClick = {
    if (inputText.isNotBlank()) {
        val messageContent = inputText.trim()
        
        // 检查敏感词
        if (SecretaryReplyManager.containsSensitiveWords(messageContent)) {
            // 显示警告并清空输入框
            val warningMessage = ChatMessage(
                sender = MessageSender.SECRETARY,
                content = "⚠️ 检测到敏感词，请不要讨论政治相关话题哦，老板！"
            )
            messages = messages + warningMessage
            inputText = ""
            return@IconButton
        }
        
        // 正常发送流程...
    }
}
```

## 效果对比

### 修复前 ❌
| 玩家输入 | 秘书回复 | 问题 |
|---------|---------|------|
| 你好吗？ | 记得按时吃饭哦，老板！ | 答非所问 |
| 习近平 | 没问题！ | 未拦截敏感词 |
| 随便输入 | 我马上去办！ | 随机回复，不合理 |

### 修复后 ✅
| 玩家输入 | 秘书回复 | 说明 |
|---------|---------|------|
| 你好吗？ | 我很好，谢谢老板关心！您呢？ | 精准理解 |
| 习近平 | ⚠️ 检测到敏感词，请不要讨论政治相关话题哦，老板！ | 敏感词拦截 |
| 公司怎么样 | 咱们公司正在蓬勃发展中！ | 工作相关回复 |
| 辛苦了 | 不客气，老板！这是我应该做的。 | 感谢类回复 |
| 随便输入 | 老板，您说什么？我没太听懂... | 兜底回复避免乱答 |

## 特性总结

### ✅ 核心改进
1. **完全杜绝答非所问**：通过多层次语义匹配和兜底回复
2. **严格敏感词过滤**：覆盖国家领导人、政治人物、敏感事件
3. **智能理解能力**：支持问候、工作、关心、情感等多种场景
4. **用户体验优化**：回复更贴切、更自然、更符合秘书角色

### 🔒 安全机制
- 输入层拦截：发送前检测敏感词
- 回复层拦截：双重保险
- 友好提示：不显示具体敏感词，避免二次传播

### 🎯 智能特性
- 优先级匹配：重要场景优先响应
- 随机回复：同类问题多样化回复，避免重复
- 符号理解：识别问号、感叹号等表达情绪
- 兜底机制：无法识别时坦诚告知，而非乱答

## 维护说明

### 如何添加新的敏感词
在 `SecretaryReplyManager` 中找到对应列表添加：
```kotlin
private val politicalFigures = listOf(
    "习近平", "李强", ..., 
    "新增的敏感人名"  // 添加在这里
)
```

### 如何添加新的回复模式
在 `SecretaryReplyManager` 中添加新的模式映射：
```kotlin
private val newPatterns = mapOf(
    listOf("关键词1", "关键词2") to listOf(
        "回复1",
        "回复2"
    )
)
```

然后在 `allPatterns` 列表中添加：
```kotlin
val allPatterns = listOf(
    greetingPatterns,
    statusPatterns,
    // ... 其他模式
    newPatterns  // 添加新模式
)
```

## 总结

通过**智能语义匹配 + 严格敏感词过滤**，彻底解决了秘书回复质量问题，同时确保内容安全合规。用户可以体验到更自然、更智能的对话交互。
