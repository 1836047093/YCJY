# 子公司游戏收益修复说明

## 修复日期
2024-01-23

## 问题描述

用户反馈子公司网游收入严重偏低：
- **实际情况**：70万活跃玩家，5个付费内容，月收入只有34.5万
- **预期收入**：应该在200万以上

## 根本原因

发现了两个独立的严重bug：

### Bug 1：旧存档付费内容未同步到RevenueManager

**问题**：
- 旧存档加载时，会为子公司网游生成付费内容（`MonetizationItem`）
- 但只更新了 `games` 变量，**没有调用 `RevenueManager.updateGameInfo()`**
- 导致日结算时从内存获取付费内容为空列表，只计算注册收入

**影响范围**：
- 旧存档中的子公司网游（`id.startsWith("inherited_")`）

**修复位置**：
- `MainActivity.kt` 第2291-2306行

**修复方案**：
```kotlin
if (needUpdateGames) {
    games = updatedGames
    Log.d("GameScreen", "【实例 $instanceId】✓ 已更新子公司网游的付费内容")
    
    // 🔧 修复：同步更新RevenueManager中的付费内容信息
    updatedGames
        .filter { it.id.startsWith("inherited_") && it.businessModel == BusinessModel.ONLINE_GAME }
        .forEach { game ->
            RevenueManager.updateGameInfo(
                game.id,
                game.businessModel,
                game.monetizationItems
            )
            Log.d("GameScreen", "【实例 $instanceId】✓ 同步 ${game.name} 的付费内容到RevenueManager（${game.monetizationItems.size}个）")
        }
}
```

### Bug 2：子公司收入计算使用错误公式

**问题**：
- `SubsidiaryManager.calculateMonthlyIncome()` 使用简化公式：
  ```kotlin
  val monthlyRevenue = (game.activePlayers * 0.005 * 100).toLong()
  ```
- 只计算了 **0.5%** 的付费率（相当于只有1个付费内容）
- 而竞争对手网游实际有5个付费内容，总付费率约 **3.5%**

**数值对比**：

| 计算方式 | 付费率 | 70万玩家月收入 | 偏差 |
|---------|--------|---------------|-----|
| 旧公式（简化） | 0.5% | 35万 | -86% ❌ |
| 新公式（完整） | 3.5% | ~245万 | 正确 ✅ |

**修复位置**：
- `CompetitorData.kt` 第783行：将 `calculateCompetitorMonetizationRevenue()` 从 `private` 改为 `public`
- `SubsidiaryData.kt` 第199-220行：使用完整付费内容系统计算

**修复方案**：
```kotlin
// 🔧 修复：使用完整的付费内容系统计算收入（5个付费内容，总付费率约3.5%）
val monthlyRevenue = CompetitorManager.calculateCompetitorMonetizationRevenue(
    game.activePlayers, 
    game.theme
).toLong()
```

## 付费内容系统说明

竞争对手和子公司网游使用5个付费内容，根据游戏主题配置：

**标准付费率**（V2激进版）：
- 皮肤与外观：0.5%
- 成长加速道具：0.8%
- 稀有装备：0.3%
- 赛季通行证：1.5%
- 强力角色：0.4%
- **总计：约3.5%**

**价格档位**：
- 皮肤：30-198元
- 道具：18-68元
- 装备：68-198元
- 通行证：68-198元
- 角色：98-328元

## 修复效果

**70万活跃玩家的MOBA游戏示例**：

| 付费内容 | 付费率 | 购买人数 | 平均价格 | 月收入 |
|---------|--------|---------|---------|--------|
| 皮肤与外观 | 0.5% | 3,500人 | 98元 | 34.3万 |
| 成长加速道具 | 0.8% | 5,600人 | 68元 | 38.1万 |
| 稀有装备 | 0.3% | 2,100人 | 198元 | 41.6万 |
| 赛季通行证 | 1.5% | 10,500人 | 198元 | 207.9万 |
| 强力角色 | 0.4% | 2,800人 | 328元 | 91.8万 |
| **合计** | **3.5%** | **24,500人** | - | **~414万** |

**收入提升**：从 **35万/月** → **200-400万/月**（根据主题和随机波动）

## 向后兼容

✅ 旧存档自动生成付费内容并同步到RevenueManager
✅ 新收购的子公司使用正确的收入计算公式
✅ 不影响玩家自研游戏的收入计算
✅ 已发售的子公司游戏月结算时自动使用新公式

## 测试建议

1. **旧存档测试**：
   - 加载含有子公司网游的旧存档
   - 检查日志确认付费内容已生成和同步
   - 等待一次月结算，查看月收入是否正常

2. **新收购测试**：
   - 收购一家拥有网游的竞争对手
   - 查看子公司月收入是否合理
   - 70万活跃应该在200-400万/月范围

3. **数值验证**：
   - 子公司界面查看月收入
   - 财务状况查看子公司收入
   - 确保与活跃玩家数成正比

## 开发经验

**教训**：
1. 生成数据后必须同步到所有相关管理器（RevenueManager、ServerManager等）
2. 简化公式只能用于估算，正式计算必须使用完整系统
3. 数值设计要保持一致性（竞争对手、子公司、玩家游戏）

**建议**：
- 关键数值计算抽取为公共函数，避免重复实现
- 添加单元测试验证收入计算逻辑
- 记录详细日志便于问题排查
