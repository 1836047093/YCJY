# 兑换码系统架构说明

## 概述

你的游戏现在支持 **三种兑换码系统**，可以根据需求灵活选择：

1. **本地兑换码**（RedeemCodeManager）- 离线验证
2. **Firebase 兑换码**（FirebaseRedeemCodeManager）- 国际版云端验证
3. **LeanCloud 兑换码**（LeanCloudRedeemCodeManager）- 国内版云端验证 + 管理后台

## 系统对比

| 特性 | 本地验证 | Firebase | LeanCloud |
|------|---------|----------|-----------|
| **网络要求** | ❌ 离线可用 | ✅ 需要联网 | ✅ 需要联网 |
| **跨设备同步** | ❌ 不支持 | ✅ 支持 | ✅ 支持 |
| **管理后台** | ❌ 无 | ❌ 需自建 | ✅ 已有 |
| **防作弊** | ⚠️ 弱 | ✅ 强 | ✅ 强 |
| **国内访问** | ✅ 稳定 | ⚠️ 需优化 | ✅ 稳定快速 |
| **数据追踪** | ❌ 无 | ✅ 有 | ✅ 有 |
| **实时统计** | ❌ 无 | ✅ 有 | ✅ 有 |

## 推荐使用方案

### 方案 1: 纯 LeanCloud（推荐）

**适用场景**：
- ✅ 已有游戏管理后台
- ✅ 需要实时数据统计
- ✅ 需要严格防作弊
- ✅ 主要面向国内用户

**优势**：
- 统一管理：后台生成 → LeanCloud存储 → 游戏验证
- 国内访问快速稳定
- 实时数据追踪
- 完整的使用记录

**实现**：
```kotlin
// 使用 LeanCloud 兑换
when (val result = LeanCloudRedeemCodeManager.redeemCode(userId, code)) {
    is LeanCloudRedeemCodeManager.RedeemResult.Success -> {
        // 兑换成功
    }
    // ... 其他情况
}
```

### 方案 2: Firebase + LeanCloud 双系统

**适用场景**：
- ✅ 同时面向国内外用户
- ✅ 需要高可用性
- ✅ 希望互相备份

**优势**：
- Firebase 服务国际用户
- LeanCloud 服务国内用户
- 两套数据互相备份
- 更高的可用性

**实现**：
```kotlin
// 优先使用 LeanCloud，失败时降级到 Firebase
coroutineScope.launch {
    var result: Boolean = false
    
    // 1. 尝试 LeanCloud
    if (LeanCloudConfig.isInitialized()) {
        when (val lcResult = LeanCloudRedeemCodeManager.redeemCode(userId, code)) {
            is LeanCloudRedeemCodeManager.RedeemResult.Success -> {
                result = true
                // 同步到 Firebase 作为备份
                FirebaseRedeemCodeManager.recordUserRedeem(userId, code, lcResult.type)
            }
            LeanCloudRedeemCodeManager.RedeemResult.NetworkError -> {
                // 网络错误，降级到 Firebase
                Log.w("Redeem", "LeanCloud网络错误，降级到Firebase")
            }
            else -> {
                // 其他错误（已使用、不存在等），不降级
                return@launch
            }
        }
    }
    
    // 2. 如果 LeanCloud 失败，尝试 Firebase
    if (!result) {
        when (val fbResult = FirebaseRedeemCodeManager.redeemCode(userId, code)) {
            is FirebaseRedeemCodeManager.RedeemResult.Success -> {
                result = true
            }
            // ... 处理其他情况
        }
    }
}
```

### 方案 3: 本地 + LeanCloud 混合

**适用场景**：
- ✅ 有预设兑换码（如测试码）
- ✅ 有动态兑换码（管理后台生成）

**优势**：
- 预设码无需网络
- 动态码支持实时管理
- 灵活性最高

**实现**：
```kotlin
// 先检查本地预设码
if (RedeemCodeManager.isValidSupporterCode(code)) {
    // 本地预设码
    if (!RedeemCodeManager.isCodeUsedByUser(this, userId, code)) {
        RedeemCodeManager.markCodeAsUsed(this, userId, code)
        // 兑换成功
    }
} else {
    // 尝试 LeanCloud 动态码
    when (val result = LeanCloudRedeemCodeManager.redeemCode(userId, code)) {
        is LeanCloudRedeemCodeManager.RedeemResult.Success -> {
            // 兑换成功
        }
        // ... 其他情况
    }
}
```

## 数据同步策略

### 启动时同步（推荐）

在用户登录后，立即从云端同步解锁状态：

```kotlin
LaunchedEffect(userId) {
    if (userId != null) {
        // 从 LeanCloud 同步
        val gmUnlocked = LeanCloudRedeemCodeManager.isGMUnlocked(userId)
        val supporterUnlocked = LeanCloudRedeemCodeManager.isSupporterUnlocked(userId)
        
        isGMUnlocked = gmUnlocked
        isSupporterUnlocked = supporterUnlocked
        
        // 如果使用双系统，也从 Firebase 同步
        if (!gmUnlocked) {
            isGMUnlocked = FirebaseRedeemCodeManager.isGMUnlocked(userId)
        }
        if (!supporterUnlocked) {
            isSupporterUnlocked = FirebaseRedeemCodeManager.isSupporterUnlocked(userId)
        }
    }
}
```

### 实时同步

兑换成功后，同步到所有系统：

```kotlin
// LeanCloud 兑换成功
when (val result = LeanCloudRedeemCodeManager.redeemCode(userId, code)) {
    is LeanCloudRedeemCodeManager.RedeemResult.Success -> {
        // 1. 更新本地状态
        when (result.type) {
            "gm" -> isGMUnlocked = true
            "supporter" -> isSupporterUnlocked = true
        }
        
        // 2. 同步到 Firebase（可选）
        FirebaseRedeemCodeManager.recordUserRedeem(userId, code, result.type)
        
        // 3. 保存到本地（可选，作为缓存）
        RedeemCodeManager.markCodeAsUsed(context, userId, code)
    }
}
```

## 迁移指南

### 从 Firebase 迁移到 LeanCloud

如果你之前使用 Firebase，现在想切换到 LeanCloud：

#### 步骤 1: 保持 Firebase 代码不动

先不删除 Firebase 相关代码，保持兼容。

#### 步骤 2: 添加 LeanCloud 支持

按照 [LeanCloud配置清单.md](./LeanCloud配置清单.md) 完成配置。

#### 步骤 3: 添加数据迁移逻辑

```kotlin
// 在用户登录后，一次性迁移 Firebase 数据到 LeanCloud
LaunchedEffect(userId) {
    if (userId != null) {
        // 1. 从 Firebase 读取解锁状态
        val fbGMUnlocked = FirebaseRedeemCodeManager.isGMUnlocked(userId)
        val fbSupporterUnlocked = FirebaseRedeemCodeManager.isSupporterUnlocked(userId)
        
        // 2. 检查 LeanCloud 是否已有记录
        val lcGMUnlocked = LeanCloudRedeemCodeManager.isGMUnlocked(userId)
        val lcSupporterUnlocked = LeanCloudRedeemCodeManager.isSupporterUnlocked(userId)
        
        // 3. 如果 Firebase 有但 LeanCloud 没有，则迁移
        if (fbGMUnlocked && !lcGMUnlocked) {
            // 创建一个迁移记录（使用特殊兑换码）
            LeanCloudRedeemCodeManager.recordUserRedeem(userId, "MIGRATED_GM", "gm")
            Log.d("Migration", "已迁移GM功能")
        }
        
        if (fbSupporterUnlocked && !lcSupporterUnlocked) {
            LeanCloudRedeemCodeManager.recordUserRedeem(userId, "MIGRATED_SUPPORTER", "supporter")
            Log.d("Migration", "已迁移支持者功能")
        }
        
        // 4. 使用 LeanCloud 的状态
        isGMUnlocked = lcGMUnlocked || fbGMUnlocked
        isSupporterUnlocked = lcSupporterUnlocked || fbSupporterUnlocked
    }
}
```

#### 步骤 4: 逐步切换

1. **第1周**：双系统并行，新兑换优先使用 LeanCloud
2. **第2-4周**：观察数据，确保 LeanCloud 稳定
3. **第5周**：完全切换到 LeanCloud，移除 Firebase 代码（可选）

### 从本地迁移到 LeanCloud

如果你之前只用本地验证，想升级到云端：

```kotlin
LaunchedEffect(userId) {
    if (userId != null) {
        // 读取本地已使用的兑换码
        val localCodes = RedeemCodeManager.getUsedCodes(context, userId)
        
        // 迁移到 LeanCloud
        localCodes.forEach { code ->
            // 判断类型（根据你的本地规则）
            val type = when {
                code.startsWith("GM") -> "gm"
                code.startsWith("SUP") -> "supporter"
                else -> "unknown"
            }
            
            // 上传到云端
            LeanCloudRedeemCodeManager.recordUserRedeem(userId, code, type)
        }
        
        Log.d("Migration", "已迁移 ${localCodes.size} 个本地兑换码到云端")
    }
}
```

## 性能优化

### 1. 缓存解锁状态

```kotlin
// 使用 remember 缓存，避免重复查询
val gmUnlocked by remember(userId) {
    mutableStateOf(false)
}

LaunchedEffect(userId) {
    if (userId != null && !gmUnlocked) {
        // 只在未解锁时查询
        gmUnlocked = LeanCloudRedeemCodeManager.isGMUnlocked(userId)
    }
}
```

### 2. 批量查询

```kotlin
// 一次性获取所有解锁状态
suspend fun getAllUnlockStatus(userId: String): UnlockStatus {
    return coroutineScope {
        val gmDeferred = async { LeanCloudRedeemCodeManager.isGMUnlocked(userId) }
        val supporterDeferred = async { LeanCloudRedeemCodeManager.isSupporterUnlocked(userId) }
        
        UnlockStatus(
            gm = gmDeferred.await(),
            supporter = supporterDeferred.await()
        )
    }
}
```

### 3. 超时处理

```kotlin
// 设置合理的超时，避免长时间等待
withTimeoutOrNull(5000L) {
    LeanCloudRedeemCodeManager.redeemCode(userId, code)
} ?: run {
    // 超时处理
    showError("网络超时，请重试")
}
```

## 监控和日志

### 重要日志点

1. **初始化**：
   - `✅ LeanCloud初始化成功`
   - `❌ LeanCloud初始化失败`

2. **兑换流程**：
   - `开始验证兑换码: {code}`
   - `✅ 兑换码验证成功: {code}, 类型: {type}`
   - `❌ 兑换码不存在: {code}`

3. **同步状态**：
   - `LeanCloud同步: GM={bool}, 支持者={bool}`

### 监控指标

在 LeanCloud 控制台可以查看：
- 兑换码使用量
- 用户兑换记录
- API 调用次数
- 错误率

## 常见问题

### Q1: 三种系统可以同时使用吗？

**A**: 可以，但需要注意：
- 避免重复验证同一兑换码
- 确保解锁状态一致性
- 建议使用"优先级降级"策略（LeanCloud → Firebase → 本地）

### Q2: 如何选择使用哪个系统？

**A**: 根据场景选择：
- **本地**：测试、演示、离线体验
- **Firebase**：国际用户、已有Firebase基础设施
- **LeanCloud**：国内用户、需要管理后台、需要数据统计

### Q3: 数据不同步怎么办？

**A**: 设置数据同步策略：
1. 兑换成功后同步到所有系统
2. 启动时从所有系统读取并合并
3. 以云端数据为准（LeanCloud/Firebase）

## 总结

你现在有三套完整的兑换码系统：

1. **LeanCloudRedeemCodeManager** - 最新接入，推荐使用
2. **FirebaseRedeemCodeManager** - 已有实现，可继续使用
3. **RedeemCodeManager** - 本地验证，作为降级方案

**推荐配置**：
- 主要使用 **LeanCloud**（国内稳定 + 管理后台）
- 保留 **Firebase** 作为备份或国际用户
- 保留 **本地** 作为离线降级方案

这样既保证了灵活性，又确保了高可用性！

## 相关文档

- [LeanCloud配置清单.md](./LeanCloud配置清单.md)
- [LeanCloud兑换码接入指南.md](./LeanCloud兑换码接入指南.md)
- [Firebase兑换码系统实现说明.md](./Firebase兑换码系统实现说明.md)
