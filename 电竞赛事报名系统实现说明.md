# 电竞赛事报名系统实现说明

## 修改概述

已完成筹备阶段报名机制的实现，现在赛事筹备期需要战队主动报名才能参赛。

## 核心修改

### 1. 数据结构修改 (TournamentData.kt)

#### EsportsTournament 新增字段：
- `registeredTeams: List<String>` - 已报名战队列表（筹备期使用）
- `hasPlayerTeamRegistered: Boolean` - 玩家战队是否已报名
- `participatingTeams` - 改为正式比赛时才确定的参赛队伍

#### 新增方法：
- `getRequiredTeamCount()` - 获取需要的战队数量（城市杯8支，全国赛16支，全球赛24支）
- `canRegister()` - 判断是否可以报名（筹备期且未满员）

### 2. TournamentManager 新增功能

#### 报名相关：
```kotlin
fun registerTeam(
    tournament: EsportsTournament,
    teamName: String,
    isPlayerTeam: Boolean = false
): EsportsTournament
```
- 战队报名功能
- 检查是否已报名、是否满员

```kotlin
fun autoRegisterAITeams(tournament: EsportsTournament): EsportsTournament
```
- AI战队自动报名
- 每天30%概率有AI战队报名

#### 赛事更新逻辑修改：
- 筹备期每天自动触发AI战队报名
- 筹备期结束时，根据报名情况确定参赛队伍
- 如果报名不足，自动补充AI战队

#### 抽签仪式修改：
- 使用已报名的战队进行抽签
- 如果报名不足4支队伍，不显示抽签仪式

### 3. UI 修改 (TournamentScreen.kt)

#### TournamentScreen 主界面：
- 新增 `onRegisterTeam: ((String, String) -> Unit)?` 参数
- 传递报名回调到子组件

#### OngoingTournamentsTab：
- 新增 `onRegisterTeam` 参数
- 只有玩家公司可以报名（竞争对手不能）

#### OngoingTournamentCard：
- 新增 `onRegisterTeam` 参数
- 筹备期显示报名信息：
  - 已报名数量 / 需要数量
  - 玩家战队是否已报名

#### TournamentDetailDialog：
- 新增 `onRegisterTeam` 参数
- 筹备期显示：
  - 已报名战队列表
  - 报名进度（X/Y）
  - 报名截止提示
- 底部按钮：
  - 如果玩家战队未报名且可以报名，显示"报名参赛"按钮
  - 报名后按钮消失

## 使用流程

### 1. 举办赛事
```kotlin
// 创建赛事时，registeredTeams 为空
val tournament = TournamentManager.createTournament(game, type, currentDate)
```

### 2. 筹备期报名
```kotlin
// 玩家战队报名
val updatedTournament = TournamentManager.registerTeam(
    tournament = tournament,
    teamName = "我的战队",
    isPlayerTeam = true
)

// AI战队自动报名（每日更新时调用）
val withAITeams = TournamentManager.autoRegisterAITeams(updatedTournament)
```

### 3. 筹备期结束
- 系统自动确定参赛队伍
- 如果报名不足，补充AI战队
- 进入正式比赛阶段

## MainActivity 集成示例

需要在 MainActivity 中添加报名处理：

```kotlin
// 在 MainActivity 中添加
fun handleTournamentRegistration(gameId: String, teamName: String) {
    val game = games.find { it.id == gameId } ?: return
    val tournament = game.currentTournament ?: return
    
    // 检查是否可以报名
    if (!tournament.canRegister()) {
        showMessage("报名已截止或已满员")
        return
    }
    
    // 检查是否已报名
    if (tournament.hasPlayerTeamRegistered) {
        showMessage("你的战队已经报名")
        return
    }
    
    // 执行报名
    val updatedTournament = TournamentManager.registerTeam(
        tournament = tournament,
        teamName = teamName,
        isPlayerTeam = true
    )
    
    // 更新游戏数据
    val updatedGame = game.copy(currentTournament = updatedTournament)
    updateGame(updatedGame)
    
    showMessage("报名成功！")
}

// 在 TournamentScreen 调用处传递回调
TournamentScreen(
    games = games,
    revenueDataMap = revenueDataMap,
    currentDate = currentDate,
    money = money,
    fans = fans,
    competitors = competitors,
    onHostTournament = { gameId, type -> handleHostTournament(gameId, type) },
    onRegisterTeam = { gameId, teamName -> handleTournamentRegistration(gameId, teamName) }
)
```

## 显示效果

### 筹备期卡片：
```
🥉 城市杯
游戏名称

📋 筹备阶段
正在筹备赛事，招募战队和赞助商

筹备中 (3/14天)
[进度条]

📝 已报名: 5/8
✓ 你的战队已报名
```

### 详情对话框（筹备期）：
```
📋 筹备进度
第 3 天 / 共 14 天
[进度条]

⚔️ 已报名战队 (5/8)
1. 我的战队
2. 龙之战队
3. 凤凰俱乐部
4. 狂暴电竞
5. 闪电联盟

💡 报名截止：筹备期结束前

💰 赞助商 (3家)
🏢 华为科技
🏢 康师傅
🏢 中国银行

[报名参赛] [关闭]  <- 如果未报名显示报名按钮
```

## 注意事项

1. **玩家战队名称**：目前使用固定的"我的战队"，后续可以改为从战队管理系统获取真实战队名
2. **AI战队报名**：每天30%概率，确保筹备期内能逐步填满名额
3. **报名不足处理**：如果筹备期结束时报名不足，自动补充AI战队
4. **抽签条件**：至少需要4支队伍才会显示抽签仪式
5. **竞争对手**：竞争对手的赛事不能报名，只能查看

## 后续优化建议

1. 从战队管理系统获取真实战队名称和Logo
2. 添加报名费用（可选）
3. 添加报名条件检查（战队实力、战队人数等）
4. 显示已报名战队的实力评级
5. 添加退出报名功能
6. 报名满员后显示候补名单
