# æœåŠ¡å™¨æ‰£è´¹BUGä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°
æœåŠ¡å™¨ç§Ÿç”¨åæ²¡æœ‰æŒ‰æœˆè‡ªåŠ¨æ‰£é™¤æœˆè´¹ã€‚

## æ ¹æœ¬åŸå› 
1. **åºåˆ—åŒ–BUG**ï¼šæœåŠ¡å™¨æ•°æ®ä¿å­˜æ—¶ï¼Œæ²¡æœ‰ä¿å­˜`lastBillingYear/Month/Day`å­—æ®µ
2. **æ‰£è´¹å‘¨æœŸé”™è¯¯**ï¼šåŸæ¥æ˜¯>=30å¤©æ‰æ‰£è´¹ï¼Œåº”è¯¥æ˜¯>=29å¤©ï¼ˆç¬¬30å¤©æ‰£è´¹ï¼‰
3. **å…¬å…±æ± æ’é™¤é”™è¯¯**ï¼šä»£ç é”™è¯¯åœ°æ’é™¤äº†å…¬å…±æ± ï¼ˆSERVER_PUBLIC_POOLï¼‰çš„è®¡è´¹ï¼Œä½†æ‰€æœ‰æœåŠ¡å™¨éƒ½åœ¨å…¬å…±æ± ä¸­ï¼

## å·²ä¿®å¤å†…å®¹

### 1. GameRevenueData.kt
- âœ… **ç¬¬204-206è¡Œ**ï¼šæ·»åŠ lastBillingå­—æ®µçš„åºåˆ—åŒ–ä¿å­˜
- âœ… **ç¬¬174-175è¡Œ**ï¼šåŠ è½½æ•°æ®åè‡ªåŠ¨è¿ç§»ï¼Œå¼ºåˆ¶ä¿å­˜ä¸€æ¬¡
- âœ… **ç¬¬1225è¡Œ**ï¼šä¿®æ­£æ‰£è´¹å‘¨æœŸä»>=30æ”¹ä¸º>=29
- âœ… **ç¬¬1201-1247è¡Œ**ï¼š**ç§»é™¤å…¬å…±æ± æ’é™¤é€»è¾‘**ï¼Œè®©æ‰€æœ‰æœåŠ¡å™¨éƒ½æ­£å¸¸è®¡è´¹
- âœ… **ç¬¬1172-1177è¡Œ**ï¼šä¿®å¤calculateTotalMonthlyServerCostå‡½æ•°
- âœ… **ç¬¬1194-1260è¡Œ**ï¼šæ·»åŠ è¯¦ç»†æ‰£è´¹æ—¥å¿—

### 2. MainActivity.kt  
- âœ… **ç¬¬1152-1163è¡Œ**ï¼šå¢å¼ºæ‰£è´¹æ—¥å¿—ï¼Œæ˜¾ç¤ºèµ„é‡‘å˜åŒ–

## æ“ä½œæ­¥éª¤ï¼ˆé‡è¦ï¼ï¼‰

### **æ–¹æ³•1ï¼šé‡æ–°ç¼–è¯‘å®‰è£…ï¼ˆæ¨èï¼‰**
1. å…³é—­å½“å‰è¿è¡Œçš„æ¸¸æˆ
2. ç‚¹å‡»IDEé¡¶éƒ¨çš„ **Run** æŒ‰é’®ï¼ˆç»¿è‰²ä¸‰è§’å½¢ï¼‰æˆ–æŒ‰ `Shift+F10`
3. ç­‰å¾…ç¼–è¯‘å®Œæˆå¹¶è‡ªåŠ¨å®‰è£…åˆ°æ¨¡æ‹Ÿå™¨/è®¾å¤‡
4. å¯åŠ¨æ¸¸æˆ
5. æŸ¥çœ‹logcatæ—¥å¿—ï¼ˆè¿‡æ»¤"ServerBilling"æ ‡ç­¾ï¼‰

### **æ–¹æ³•2ï¼šå¦‚æœè¿˜æ˜¯ä¸æ‰£è´¹**
å¦‚æœé‡æ–°å®‰è£…åè¿˜æ˜¯ä¸æ‰£è´¹ï¼Œå¯èƒ½æ˜¯æ—§å­˜æ¡£æ•°æ®æŸåï¼Œéœ€è¦ï¼š
1. åœ¨æ¸¸æˆè®¾ç½®ä¸­åˆ é™¤å½“å‰å­˜æ¡£
2. å¼€å§‹æ–°æ¸¸æˆ
3. ç§Ÿç”¨æœåŠ¡å™¨
4. å¿«è¿›30å¤©æµ‹è¯•

## éªŒè¯æ–¹æ³•

### æŸ¥çœ‹æ—¥å¿—
åœ¨logcatä¸­æœç´¢ `ServerBilling`ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
```
ServerBilling: æœåŠ¡å™¨xxx - ç±»å‹:æ˜Ÿå°˜-Då‹æœåŠ¡å™¨, ä¸Šæ¬¡æ‰£è´¹:1å¹´1æœˆ3æ—¥, å½“å‰:1å¹´2æœˆ2æ—¥, è·ç¦»å¤©æ•°:29å¤©(åŒ…å«ç§Ÿç”¨å½“å¤©=30å¤©), æœˆè´¹:Â¥100000
ServerBilling: âœ“ æ‰£è´¹æˆåŠŸï¼æœåŠ¡å™¨xxx - Â¥100000, ç´¯è®¡:Â¥100000
MainActivity: ğŸ’° æœåŠ¡å™¨è®¡è´¹: -Â¥100000 (æ‰£è´¹å‰:Â¥1.0M -> æ‰£è´¹å:Â¥900000)
```

### æ‰£è´¹è§„åˆ™
- **ç§Ÿç”¨æ—¥æœŸ**ï¼š1å¹´1æœˆ3æ—¥
- **é¦–æ¬¡æ‰£è´¹**ï¼š1å¹´2æœˆ2æ—¥ï¼ˆç¬¬30å¤©ï¼‰
- **ç¬¬äºŒæ¬¡æ‰£è´¹**ï¼š1å¹´3æœˆ2æ—¥ï¼ˆç¬¬60å¤©ï¼‰
- **ç¬¬ä¸‰æ¬¡æ‰£è´¹**ï¼š1å¹´4æœˆ1æ—¥ï¼ˆç¬¬90å¤©ï¼‰

## æŠ€æœ¯ç»†èŠ‚

### æ‰£è´¹å‘¨æœŸè®¡ç®—
```kotlin
// è®¡ç®—é—´éš”å¤©æ•°ï¼ˆä¸åŒ…å«èµ·å§‹æ—¥ï¼‰
val daysSinceLastBilling = calculateDaysSinceLaunch(
    releaseYear = server.lastBillingYear,
    releaseMonth = server.lastBillingMonth,
    releaseDay = server.lastBillingDay,
    currentYear = currentYear,
    currentMonth = currentMonth,
    currentDay = currentDay
)

// å¦‚æœé—´éš”>=29å¤©ï¼ˆå³ç¬¬30å¤©ï¼‰ï¼Œæ‰£è´¹
if (daysSinceLastBilling >= 29) {
    // æ‰£è´¹å¹¶æ›´æ–°lastBillingæ—¥æœŸ
}
```

### æ•°æ®æŒä¹…åŒ–
```kotlin
// åºåˆ—åŒ–æ—¶ä¿å­˜æ‰€æœ‰å­—æ®µ
sb.append("\"lastBillingYear\":${server.lastBillingYear},")
sb.append("\"lastBillingMonth\":${server.lastBillingMonth},")
sb.append("\"lastBillingDay\":${server.lastBillingDay}")

// ååºåˆ—åŒ–æ—¶è¯»å–ï¼Œå…¼å®¹æ—§å­˜æ¡£
val lastBillingYear = extractIntFieldOrDefault(serverJson, "lastBillingYear", purchaseYear)
val lastBillingMonth = extractIntFieldOrDefault(serverJson, "lastBillingMonth", purchaseMonth)
val lastBillingDay = extractIntFieldOrDefault(serverJson, "lastBillingDay", purchaseDay)
```

## å¦‚æœè¿˜æ˜¯æœ‰é—®é¢˜

1. **æ£€æŸ¥APKç‰ˆæœ¬**ï¼šç¡®ä¿å®‰è£…çš„æ˜¯æœ€æ–°ç¼–è¯‘çš„ç‰ˆæœ¬
2. **æ¸…é™¤åº”ç”¨æ•°æ®**ï¼šåœ¨è®¾å¤‡è®¾ç½®ä¸­æ¸…é™¤åº”ç”¨æ•°æ®åé‡æ–°æµ‹è¯•
3. **æŸ¥çœ‹å®Œæ•´æ—¥å¿—**ï¼šæœç´¢"MainActivity"å’Œ"ServerBilling"æ ‡ç­¾ï¼Œæˆªå›¾å‘ç»™æˆ‘
4. **æ£€æŸ¥å­˜æ¡£æ–‡ä»¶**ï¼šSharedPreferencesä¸­server_mapçš„JSONæ•°æ®

---

**ä¿®å¤æ—¥æœŸ**ï¼š2025å¹´3æœˆ14æ—¥  
**ä¿®å¤ç‰ˆæœ¬**ï¼šv1.1ï¼ˆæœåŠ¡å™¨æ‰£è´¹ä¿®å¤ç‰ˆï¼‰
