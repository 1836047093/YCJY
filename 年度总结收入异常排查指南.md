# 年度总结收入异常排查指南

## 问题现象

玩家反馈：
- ✅ 没有发售过任何游戏
- ❌ 但年度总结显示有巨额收入（如¥121.50M）

---

## 可能原因排查

### 1. 收购子公司继承游戏 ⭐最可能

**检查方法**：
```
1. 打开"项目管理"
2. 查看筛选选项是否有"子公司游戏"
3. 切换到"子公司游戏"，查看是否有游戏
```

**判断标准**：
- ✅ 如果有游戏显示 → **原因确认**：继承游戏产生的收入
- ❌ 如果没有 → 继续排查其他原因

**解释**：
- 当您收购竞争对手公司时，会继承他们的游戏
- 这些游戏会自动产生收益
- 这些游戏的ID以`inherited_`开头
- 它们会计入年度总结的收入

**解决方案**：
- ✅ **这是正常行为**，不是bug
- 继承的游戏会持续产生收益
- 建议修改为显示为"运营游戏"而非"发售游戏"（已修复）

---

### 2. 旧存档数据残留

**检查方法**：
查看日志（Logcat），搜索关键字：`GameScreen` 和 `收入数据检查`

**判断标准**：
```
GameScreen: 🔍 收入数据检查:
GameScreen:   总条目数: 1  <-- 如果>0，说明有数据
GameScreen:   - 极限战歌 (继承): 记录365天, 总收入¥121500000
```

**解决方案**：
```kotlin
// 方案1：清除所有数据，开始新游戏
RevenueManager.clearAllData()

// 方案2：删除存档，重新开始
```

---

### 3. 游戏状态异常

**检查方法**：
查看日志，搜索：`发售游戏检查`

**判断标准**：
```
MainActivity: 📅 2年1月1日 - 发售游戏检查
MainActivity: 发售中游戏数量: 1  <-- 如果>0，说明有发售游戏
MainActivity:   极限战歌:
MainActivity:     - 类型: 继承游戏
MainActivity:     - 商业模式: ONLINE_GAME
MainActivity:     - 状态: RELEASED
```

**异常情况**：
- 如果显示有游戏，但您确实没有发售过
- 可能是游戏状态被错误设置为`RELEASED`

**解决方案**：
```kotlin
// 需要检查游戏列表，找出状态异常的游戏
games.filter { it.releaseStatus == GameReleaseStatus.RELEASED }
```

---

### 4. SharedPreferences残留数据

**检查方法**：
1. 完全卸载应用
2. 重新安装
3. 开始新游戏
4. 查看是否仍有收入

**判断标准**：
- ✅ 如果没有收入了 → SharedPreferences残留数据
- ❌ 如果仍有收入 → 代码逻辑问题

---

## 调试日志查看指南

### 启动时的日志

**新游戏**：
```
GameScreen: ===== 新游戏模式：清空旧数据 =====
GameScreen: ✓ 清空招聘岗位数据
GameScreen: ✓ 确认收入数据已清空  <-- 应该看到这个
```

**读档**：
```
GameScreen: ===== 读档模式：开始恢复数据 =====
GameScreen: ✓ 从存档恢复收益数据: 1 个游戏
GameScreen: 🔍 收入数据检查:
GameScreen:   总条目数: 1
GameScreen:   - 极限战歌 (继承): 记录365天, 总收入¥121500000
```

### 每月1日的日志

```
MainActivity: ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
MainActivity: 📅 2年1月1日 - 发售游戏检查
MainActivity: 发售中游戏数量: 1
MainActivity:   极限战歌:
MainActivity:     - 类型: 继承游戏  <-- 关键信息
MainActivity:     - 商业模式: ONLINE_GAME
MainActivity:     - 状态: RELEASED
MainActivity: ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 年度总结时的日志

```
YearEnd: ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
YearEnd: 📊 年度总结数据调试 - 2年
YearEnd: 收入数据总条目数: 1
YearEnd:   游戏: 极限战歌 (ID=inherited_12345...)
YearEnd:     类型: 继承游戏  <-- 关键信息
YearEnd:     发售日期: 1年1月1日
YearEnd:     本年收入记录数: 365
YearEnd:     本年总收入: ¥121500000
YearEnd: ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 常见问题 FAQ

### Q1: 我确定没有收购子公司，为什么有继承游戏？

**A**: 可能是旧存档的残留数据。检查方法：
1. 查看日志中游戏的发售日期
2. 如果发售日期早于您开始新游戏的时间 → 肯定是残留数据
3. 解决：卸载重装，或手动清除应用数据

### Q2: 子公司游戏的收入正常吗？

**A**: 完全正常！这是设计功能：
- 收购竞争对手后，继承他们的游戏
- 这些游戏会持续产生收益
- 收益会计入您的年度总结和财务状况

### Q3: 如何区分自研游戏和子公司游戏？

**A**: 
1. **UI方式**：项目管理 → 筛选 → "子公司游戏"
2. **日志方式**：查看游戏ID，`inherited_`开头的是子公司游戏
3. **财务方式**：财务状况中有单独的"子公司收入"项

### Q4: 为什么年度总结显示"运营游戏0款"但有收入？

**A**: 这是V3.0之前的bug，已修复：
- **旧逻辑**："发售游戏"只统计本年新发售的
- **新逻辑**："运营游戏"统计所有有收入的游戏
- 更新到最新版本即可

### Q5: 我想删除子公司游戏，怎么办？

**A**: 当前版本不支持删除游戏，但可以：
1. 下架游戏（停止产生新收入）
2. 等待玩家流失，收入自然降为0

---

## 代码层面的排查

### 检查点1：RevenueManager数据源

**文件**：`GameRevenueData.kt`

**检查**：
```kotlin
val revenueData = RevenueManager.exportRevenueData()
revenueData.forEach { (gameId, revenue) ->
    Log.d("Debug", "GameID: $gameId")
    Log.d("Debug", "GameName: ${revenue.gameName}")
    Log.d("Debug", "IsInherited: ${gameId.startsWith("inherited_")}")
    Log.d("Debug", "TotalRecords: ${revenue.dailySalesList.size}")
    Log.d("Debug", "TotalRevenue: ${revenue.dailySalesList.sumOf { it.revenue }}")
}
```

### 检查点2：games列表

**文件**：`MainActivity.kt`

**检查**：
```kotlin
val releasedGames = games.filter { 
    it.releaseStatus == GameReleaseStatus.RELEASED 
}
releasedGames.forEach { game ->
    Log.d("Debug", "GameName: ${game.name}")
    Log.d("Debug", "GameID: ${game.id}")
    Log.d("Debug", "IsInherited: ${game.id.startsWith("inherited_")}")
    Log.d("Debug", "Status: ${game.releaseStatus}")
}
```

### 检查点3：年度总结计算

**文件**：`MainActivity.kt` 第2900-2950行

**检查**：
- 是否包含了继承游戏的收入
- 是否正确过滤了年份
- 是否有重复计算

---

## 修复历史

### V3.0（2025-11-02）
- ✅ 添加详细调试日志
- ✅ 修改"发售游戏"为"运营游戏"
- ✅ 区分自研游戏和子公司游戏收入
- ✅ 新增启动时数据检查

### V2.0（2025-01）
- ✅ 支持子公司游戏收入统计
- ✅ 修复财务状况不显示子公司收入的bug

### V1.0（2024）
- ✅ 初始收入系统实现

---

## 下一步行动

### 对于用户

1. **查看日志**：
   - 打开Logcat
   - 搜索 `YearEnd`、`GameScreen`、`MainActivity`
   - 找到上面列出的关键日志
   - 截图发送给开发者

2. **检查子公司游戏**：
   - 打开项目管理
   - 查看是否有"子公司游戏"

3. **尝试解决**：
   - 如果是旧存档残留：卸载重装
   - 如果是子公司游戏：这是正常的！

### 对于开发者

1. **分析日志**：
   - 根据用户提供的日志
   - 确认收入数据的来源
   - 判断是功能还是bug

2. **如果是bug**：
   - 定位具体代码位置
   - 修复并测试
   - 发布补丁版本

3. **如果是功能**：
   - 向用户解释这是正常行为
   - 考虑优化UI提示
   - 添加更明确的说明文字

---

## 联系支持

如果以上方法都无法解决问题，请提供以下信息：

1. **完整日志**（从启动到年度总结）
2. **游戏版本号**
3. **操作步骤**（如何复现）
4. **存档文件**（如果可能）
5. **截图**（年度总结界面、项目管理界面）

---

**最后更新**：2025年11月2日  
**适用版本**：V3.0+  
**文档状态**：完整











