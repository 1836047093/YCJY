# 收益数据实时刷新功能修复说明

## 问题描述
在"已发售-收益预览"界面中，总收益和总销量不会随着每天的时间实时变化。

## 问题原因
虽然后台每天都在通过 `RevenueManager.addDailyRevenueForGame()` 添加新的销售数据，但是UI组件没有响应这些数据变化：

1. **数据更新**: `MainActivity.kt` 中的时间推进系统每天都会调用 `addDailyRevenueForGame` 添加新的每日收益
2. **UI未刷新**: 但是 `EnhancedGameProjectCard` 组件在显示收益时，只在首次渲染时获取数据，不会自动响应数据变化

## 解决方案
添加了一个**刷新触发器(refreshTrigger)**机制，让UI能够响应每天的数据更新：

### 修改的文件

#### 1. MainActivity.kt
```kotlin
// 添加刷新触发器变量
var revenueRefreshTrigger by remember { mutableIntStateOf(0) }

// 在时间推进系统中，每天更新收益后触发刷新
// 为已发售的游戏添加每日收益
games.filter { ... }
    .forEach { releasedGame ->
        val dailyRevenue = RevenueManager.addDailyRevenueForGame(releasedGame.id)
        money += dailyRevenue.toLong()
    }

// 触发收益数据刷新
revenueRefreshTrigger++

// 传递刷新触发器到项目管理界面
ProjectManagementWrapper(
    games = games,
    onGamesUpdate = { updatedGames -> games = updatedGames },
    founder = founder,
    allEmployees = allEmployees,
    refreshTrigger = revenueRefreshTrigger  // 新增参数
)
```

#### 2. ProjectManagementWrapper.kt
```kotlin
@Composable
fun ProjectManagementWrapper(
    games: List<Game> = emptyList(),
    onGamesUpdate: (List<Game>) -> Unit = {},
    founder: Founder? = null,
    allEmployees: List<Employee> = emptyList(),
    refreshTrigger: Int = 0  // 新增：用于触发UI刷新
) {
    EnhancedProjectManagementContent(
        // ... 其他参数
        refreshTrigger = refreshTrigger
    )
}
```

#### 3. EnhancedProjectManagement.kt
```kotlin
@Composable
fun EnhancedProjectManagementContent(
    games: List<Game> = emptyList(),
    onGamesUpdate: (List<Game>) -> Unit = {},
    founder: Founder? = null,
    availableEmployees: List<Employee> = ...,
    refreshTrigger: Int = 0  // 新增：用于触发UI刷新
) {
    // ...
    EnhancedGameProjectCard(
        game = game,
        availableEmployees = availableEmployees,
        onEmployeeAssigned = { ... },
        onGameUpdate = { ... },
        refreshTrigger = refreshTrigger  // 传递给卡片组件
    )
}
```

#### 4. EnhancedGameProjectCard.kt
```kotlin
@Composable
fun EnhancedGameProjectCard(
    game: Game,
    availableEmployees: List<Employee>,
    onEmployeeAssigned: (Game, List<Employee>) -> Unit,
    onGameUpdate: (Game) -> Unit = {},
    modifier: Modifier = Modifier,
    refreshTrigger: Int = 0  // 新增：用于触发UI刷新的参数
) {
    // 当 refreshTrigger 改变时，强制重新获取收益数据
    val gameRevenue by remember(game.id, refreshTrigger) {
        derivedStateOf { 
            if (isReleased) RevenueManager.getGameRevenue(game.id) else null
        }
    }
    
    // 收益信息显示区域（仅对已发售游戏）
    if (isReleased && gameRevenue != null) {
        val statistics = remember(gameRevenue) {
            RevenueManager.calculateStatistics(gameRevenue)
        }
        // ... 显示收益数据
    }
}
```

## 工作原理

1. **触发器递增**: 每天时间推进时，`revenueRefreshTrigger` 自动递增
2. **参数传递**: 触发器值通过组件层级传递到 `EnhancedGameProjectCard`
3. **响应式更新**: 当 `refreshTrigger` 改变时，`remember(game.id, refreshTrigger)` 会重新执行
4. **数据刷新**: 重新调用 `RevenueManager.getGameRevenue()` 获取最新数据
5. **UI重绘**: 新数据触发 Compose 重组，更新显示的总收益和总销量

## 优点

- ✅ **最小侵入性**: 只添加了一个简单的整数参数
- ✅ **性能高效**: 只在数据真正更新时才重新获取
- ✅ **代码清晰**: 使用标准的 Compose 响应式模式
- ✅ **易于维护**: 不需要复杂的状态管理逻辑

## 测试验证

修复后，收益预览应该：
1. ✅ 每天自动更新总收益和总销量
2. ✅ 实时反映游戏的销售数据变化
3. ✅ 详细收益报告中的数据也会同步更新

## 注意事项

- 刷新触发器只影响已发售游戏的收益显示
- 开发中的游戏不受影响
- 数据本身已经在后台正确更新，这个修复只是让UI能够看到这些更新