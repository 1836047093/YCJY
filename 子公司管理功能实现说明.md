# 子公司管理功能实现说明

## 功能概述

成功实现了子公司管理系统，将收购的竞争对手公司转化为可管理的子公司，而不是简单地删除。子公司可以继续运营游戏并为总公司带来利润分成。

## 核心特性

### 1. **数据模型** (`SubsidiaryData.kt`)
- **Subsidiary 数据类**：包含子公司的完整信息
  - 基本信息：名称、Logo、收购价格、收购日期
  - 财务数据：市值、月度收入/支出、累计总收入
  - 游戏数据：继承的游戏列表（网游+单机）
  - 员工数据：估算员工数量、月度工资成本
  - 管理设置：利润分成比例（默认50%）、自动管理、运营状态

- **SubsidiaryStatus 枚举**：
  - `ACTIVE`：运营中
  - `SUSPENDED`：暂停营业
  - `LIQUIDATED`：已清算

- **SubsidiaryManager 管理器**：
  - `createSubsidiary()`：从竞争对手创建子公司
  - `updateMonthlyData()`：月度数据更新
  - `calculateMonthlyIncome()`：计算月度收入
  - 员工和成本估算函数

### 2. **收购流程调整** (`MainActivity.kt`)

**原逻辑**：
```kotlin
// 移除被收购的公司
competitors = competitors.filter { it.id != acquiredCompany.id }
// 只添加IP到玩家库
ownedIPs = ownedIPs + inheritedIPs
```

**新逻辑**：
```kotlin
// ✅ 将被收购公司转换为子公司
val newSubsidiary = SubsidiaryManager.createSubsidiary(
    company = acquiredCompany,
    acquisitionPrice = finalPrice,
    acquisitionDate = GameDate(currentYear, currentMonth, currentDay)
)
subsidiaries = subsidiaries + newSubsidiary

// 移除被收购的公司
competitors = competitors.filter { it.id != acquiredCompany.id }

// IP仍然添加到玩家库（用于新游戏开发）
ownedIPs = ownedIPs + inheritedIPs
```

**关键点**：
- 子公司继承竞争对手的**所有游戏**（包括开发中和已发售）
- 游戏的IP同时添加到玩家IP库，方便使用
- 估算员工数量：基础5人 + 每款游戏5人
- 估算工资成本：员工数 × 15,000元/月

### 3. **月度结算** (`MainActivity.kt`)

每月自动更新子公司数据并处理利润分成：

```kotlin
// 月结算：更新子公司
subsidiaries = subsidiaries.map { subsidiary ->
    val updatedSubsidiary = SubsidiaryManager.updateMonthlyData(subsidiary)
    
    // 如果盈利，上缴利润分成
    val profitShare = updatedSubsidiary.getProfitShare()
    if (profitShare > 0) {
        money = safeAddMoney(money, profitShare)
        Log.d("MainActivity", "🏭 子公司[${subsidiary.name}]上缴利润...")
    }
    
    updatedSubsidiary
}
```

**月度收入计算**：
- **网游**：活跃玩家 × 0.5% × 100元/月
- **单机**：总销量 × 1% × 50元/月（持续小量销售）

**月度支出计算**：
- 员工工资：员工数 × 15,000元
- 服务器成本：网游服务器数量 × 5,000元/台
- 运营成本：游戏数量 × 10,000元/款

**游戏衰减机制**：
- 网游活跃玩家：每月衰减2%
- 单机销量：每月增长1%（持续销售）

### 4. **UI组件** (`SubsidiaryScreen.kt`)

#### **SubsidiaryMenuDialog（底部弹出菜单）**
- 显示所有子公司列表
- 每项显示：Logo、名称、月度利润、游戏数量、运营状态
- 点击进入详情界面

#### **SubsidiaryDetailDialog（详情对话框）**
分为三个部分：

**📊 财务概览**：
- 收购价格
- 当前市值
- 月度收入/支出/利润
- 利润分成金额（带比例显示）

**🎮 游戏概览**：
- 游戏总数
- 网游/单机数量
- 总活跃玩家数
- 总销量
- 估算员工数

**⚙️ 设置（预留）**：
- 利润分成比例调整
- 自动管理开关

### 5. **UI集成** (`CompetitorScreen.kt`)

在竞争对手界面右上角添加子公司入口按钮：

```
┌─────────────────────────────────────────┐
│ 🎯 竞争对手        [🏭 子公司 (2)]     │
├─────────────────────────────────────────┤
│ [📊 排行榜] [📰 新闻] [🏢 对手]         │
```

**显示条件**：
- 仅当 `subsidiaries.isNotEmpty()` 时显示
- 按钮显示子公司数量

**交互流程**：
1. 点击"子公司"按钮 → 打开子公司菜单
2. 点击某个子公司 → 打开详情对话框
3. 查看财务和游戏信息
4. 关闭对话框

### 6. **存档系统集成**

#### **SaveData 更新** (`GameData.kt`)
```kotlin
data class SaveData(
    // ... 其他字段 ...
    val subsidiaries: List<Subsidiary> = emptyList(), // ✅ 新增字段
    // ... 其他字段 ...
)
```

#### **保存数据**（`MainActivity.kt`）
在所有创建SaveData的位置添加subsidiaries字段：
- 自动存档（2623行）
- 竞争对手界面（3894行）
- 其他SaveData创建位置

#### **向后兼容**
- 默认值：`emptyList()`
- 旧存档加载时，subsidiaries自动为空列表
- 不影响现有存档正常运行

## 数值设计

### **收入公式**
| 游戏类型 | 月度收入计算 |
|---------|-------------|
| 网游 | 活跃玩家 × 0.5% × 100元 |
| 单机 | 总销量 × 1% × 50元 |

### **成本公式**
| 成本项 | 计算方式 |
|--------|---------|
| 员工工资 | 员工数 × ¥15,000 |
| 服务器 | 网游服务器 × ¥5,000 |
| 运营 | 游戏数 × ¥10,000 |

### **利润分成**
- 默认分成比例：**50%**
- 只在盈利时上缴分成
- 亏损由子公司自行承担

### **示例计算**

假设收购一家公司，有：
- 1款网游：50,000活跃玩家
- 1款单机：100,000销量
- 估算员工：15人（基础5人 + 2款游戏×5人）

**月度收入**：
- 网游：50,000 × 0.5% × 100 = ¥25,000
- 单机：100,000 × 1% × 50 = ¥50,000
- **总收入：¥75,000**

**月度支出**：
- 工资：15 × ¥15,000 = ¥225,000
- 服务器：5台（50000/10000） × ¥5,000 = ¥25,000
- 运营：2 × ¥10,000 = ¥20,000
- **总支出：¥270,000**

**月度利润**：¥75,000 - ¥270,000 = **-¥195,000**（亏损）

在这个例子中，子公司亏损，不上缴分成。随着游戏持续运营和衰减，需要观察长期表现。

## 修改文件清单

### 新增文件
1. `SubsidiaryData.kt` - 子公司数据模型和管理器
2. `SubsidiaryScreen.kt` - 子公司UI组件

### 修改文件
1. **GameData.kt**
   - SaveData添加`subsidiaries`字段

2. **MainActivity.kt**
   - 添加`subsidiaries`状态变量（2008行）
   - 修改收购成功回调，创建子公司（3904-3911行）
   - 添加月度结算子公司更新（2805-2819行）
   - 所有SaveData创建处添加subsidiaries字段（2623、3894行等）

3. **CompetitorScreen.kt**
   - 添加`onSubsidiaryUpdate`回调参数（62行）
   - 添加子公司管理状态（68-69行）
   - 修改标题栏，添加子公司入口按钮（85-115行）
   - 添加子公司菜单和详情对话框调用（157-184行）

## 使用流程

### 玩家视角

1. **收购竞争对手**
   - 在竞争对手列表选择目标公司
   - 参与竞价收购

2. **收购成功**
   - 系统提示：XX公司已转为子公司
   - 新闻：该公司已转为子公司继续运营
   - 竞争对手界面右上角出现"子公司"按钮

3. **管理子公司**
   - 点击"子公司"按钮查看所有子公司
   - 点击具体子公司查看详情
   - 查看财务报表和游戏情况

4. **收益分成**
   - 每月1日自动结算
   - 盈利的子公司自动上缴利润
   - 日志显示分成明细

## 特性总结

### ✅ 已实现功能
- [x] 收购转化为子公司（保留游戏和IP）
- [x] 子公司数据模型和状态管理
- [x] 月度自动更新和利润分成
- [x] 子公司列表UI（底部菜单）
- [x] 子公司详情UI（财务+游戏）
- [x] 完整的存档支持
- [x] 向后兼容旧存档

### 💡 后续可扩展功能
- [ ] 利润分成比例可调整
- [ ] 子公司暂停/清算操作
- [ ] 子公司间游戏转移
- [ ] 子公司自主开发新游戏
- [ ] 子公司员工详细管理
- [ ] 子公司业绩报告和图表
- [ ] 子公司间竞争和协同

## 技术亮点

1. **无需底部导航栏**：通过在竞争对手界面添加入口，避免UI过于复杂
2. **游戏继承机制**：子公司保留所有游戏，持续为总公司创造收益
3. **自动化管理**：月度自动更新，无需玩家手动操作
4. **平衡的数值设计**：收益与成本合理，避免过度盈利或亏损
5. **向后兼容**：旧存档自动适配，不影响现有玩家

## 总结

子公司管理系统已成功实现并集成到游戏中。玩家收购竞争对手后，公司将转为子公司继续运营，每月自动上缴利润分成。系统完全融入现有游戏流程，无需额外复杂操作，为玩家提供了更丰富的商业经营体验。
