# 子公司游戏总收入显示修复说明

## 问题描述

用户反馈：子公司游戏管理界面中，每个游戏的总收入一直显示相同的数据（例如16.44M），没有随时间增长。

## 问题原因

**根本原因**：每月更新子公司数据时，只更新了游戏的玩家数和销量，**没有更新每个游戏的totalRevenue字段**。

**详细分析**：

在 `SubsidiaryManager.updateMonthlyData()` 函数中（第266-279行）：

```kotlin
// 旧代码
val updatedGames = subsidiary.games.map { game ->
    when (game.businessModel) {
        com.example.yjcy.ui.BusinessModel.ONLINE_GAME -> {
            // 只更新了activePlayers，没有更新totalRevenue
            game.copy(activePlayers = (game.activePlayers * 0.98).toLong())
        }
        com.example.yjcy.ui.BusinessModel.SINGLE_PLAYER -> {
            // 只更新了salesCount，没有更新totalRevenue
            val newSales = (game.salesCount * 0.01).toLong().coerceAtLeast(10L)
            game.copy(salesCount = game.salesCount + newSales)
        }
    }
}
```

**问题所在**：
1. 网游：只更新了 `activePlayers`（玩家数衰减2%）
2. 单机：只更新了 `salesCount`（销量增长1%）
3. **两者都没有累加月度收入到 `totalRevenue` 字段**
4. 导致UI显示的游戏总收入一直是初始值（收购时的总收入）

虽然 `calculateMonthlyIncome()` 函数会计算每个游戏的月度收入，但这些收入只累加到了**子公司层面的totalRevenue**，没有累加到**每个游戏的totalRevenue**。

## 解决方案

在更新游戏数据时，同时计算并累加每个游戏的月度收入。

**修改位置**：`SubsidiaryData.kt` 第266-300行

```kotlin
// 更新游戏数据（网游玩家数衰减2%，单机销量增长）+ 累加每个游戏的收入
val updatedGames = subsidiary.games.map { game ->
    when (game.businessModel) {
        com.example.yjcy.ui.BusinessModel.ONLINE_GAME -> {
            // 网游活跃玩家缓慢衰减
            val newActivePlayers = (game.activePlayers * 0.98).toLong()
            
            // 计算本月付费内容收入
            val monthlyMonetizationRevenue = CompetitorManager.calculateCompetitorMonetizationRevenue(
                game.activePlayers, 
                game.theme
            )
            
            // 累加到游戏的总收入和付费内容收入
            game.copy(
                activePlayers = newActivePlayers,
                totalRevenue = game.totalRevenue + monthlyMonetizationRevenue,
                monetizationRevenue = game.monetizationRevenue + monthlyMonetizationRevenue
            )
        }
        com.example.yjcy.ui.BusinessModel.SINGLE_PLAYER -> {
            // 单机游戏持续小量销售
            val newSales = (game.salesCount * 0.01).toLong().coerceAtLeast(10L)
            
            // 计算本月销售收入（新增销量 × 50元）
            val monthlySalesRevenue = (newSales * 50).toDouble()
            
            // 累加到游戏的总收入
            game.copy(
                salesCount = game.salesCount + newSales,
                totalRevenue = game.totalRevenue + monthlySalesRevenue
            )
        }
    }
}
```

**关键改动**：

1. **网游**：
   - 计算本月付费内容收入（使用现有的 `calculateCompetitorMonetizationRevenue` 函数）
   - 累加到 `totalRevenue` 和 `monetizationRevenue` 字段
   - 使用**更新前的玩家数**计算收入（避免收入计算错误）

2. **单机**：
   - 计算本月销售收入（新增销量 × 50元）
   - 累加到 `totalRevenue` 字段

## 修复效果

### 网游
- ✅ 每月活跃玩家数正常衰减2%
- ✅ 每月付费内容收入累加到totalRevenue
- ✅ 每月付费内容收入累加到monetizationRevenue
- ✅ UI显示的总收入每月增长

**数值示例**（21K活跃玩家，MOBA游戏）：
- 月度付费内容收入：约11.8万元（5个付费内容，总付费率3.5%）
- 12个月后总收入：初始16.44M → 17.86M（+1.42M）

### 单机
- ✅ 每月销量正常增长1%（最少10份）
- ✅ 每月销售收入累加到totalRevenue
- ✅ UI显示的总收入每月增长

**数值示例**（67.7万份销量）：
- 月度新增销量：6770份（1%）
- 月度销售收入：33.85万元（6770 × 50元）
- 12个月后总收入：初始金额 + 406万元

## 向后兼容性

完全向后兼容：
- ✅ 不影响旧存档数据结构
- ✅ 从下一次月结算开始，游戏总收入正常累加
- ✅ 不需要重新开档

## 相关问题

这个问题类似于之前修复的**竞争对手网游总收入不变的问题**（记忆ID: b4f16137）：
- 竞争对手：修复时间2025-01-XX，给 `CompetitorGame` 添加了 `totalRevenue` 字段并在月结算时累加
- 子公司游戏：使用相同的 `CompetitorGame` 数据结构，但子公司的更新逻辑没有同步修复

## 测试建议

1. **加载旧存档**：
   - 查看子公司游戏的当前总收入
   - 等待1个月
   - 确认总收入增长

2. **新收购测试**：
   - 收购竞争对手公司
   - 查看子公司游戏的初始总收入
   - 等待几个月
   - 确认总收入每月增长

3. **数值验证**：
   - 网游：总收入增长 ≈ 活跃玩家数 × 3.5% × 平均付费价格
   - 单机：总收入增长 ≈ 销量 × 1% × 50元

## 相关文件

- `SubsidiaryData.kt`：子公司数据和更新逻辑
- `SubsidiaryScreen.kt`：子公司游戏管理UI（显示totalRevenue）
- `CompetitorData.kt`：竞争对手/子公司游戏数据结构

## 修复日期

2025-01-26
