# 合规认证切换账号功能修复说明

## 问题描述
用户点击合规认证对话框中的"切换账号"按钮后，应该退出当前登录并返回登录界面，但实际上直接进入了游戏。

## 根本原因
合规认证回调中的`SWITCH_ACCOUNT`和`EXITED`事件只记录了日志，没有实际处理退出登录和返回登录界面的逻辑。

## 解决方案

### 修改的文件
1. **YjcyApplication.kt** - 实现退出登录和重启Activity
2. **MainActivity.kt** - 简化代码，移除不必要的BroadcastReceiver

### 核心逻辑

#### YjcyApplication.kt
```kotlin
ComplianceMessage.SWITCH_ACCOUNT -> {
    Log.d(TAG, "合规认证：切换账号")
    // 1. 退出当前登录
    TapLoginManager.logout()
    // 2. 延迟200ms后重启MainActivity
    sendLogoutBroadcast()
}

ComplianceMessage.EXITED -> {
    Log.d(TAG, "合规认证：用户退出")
    // 1. 退出当前登录
    TapLoginManager.logout()
    // 2. 重启MainActivity回到登录界面
    sendLogoutBroadcast()
}

private fun sendLogoutBroadcast() {
    // 延迟200ms确保logout完成
    android.os.Handler(mainLooper).postDelayed({
        // 创建重启Intent，清除所有Activity栈
        val intent = packageManager.getLaunchIntentForPackage(packageName)
        intent?.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TASK)
        startActivity(intent)
    }, 200)
}
```

#### MainActivity.kt
```kotlin
// TapTap登录状态检查（Activity重启后会重新检查）
var isTapTapLoggedIn by remember { mutableStateOf(TapLoginManager.isLoggedIn()) }
```

## 工作流程

1. 用户点击"切换账号"或"退出游戏"
2. TapTap SDK触发对应的回调事件
3. Application调用`TapLoginManager.logout()`清除登录状态
4. **延迟200ms确保logout完成**
5. 使用`FLAG_ACTIVITY_CLEAR_TASK`清除所有Activity栈并重启MainActivity
6. MainActivity onCreate重新执行
7. `TapLoginManager.isLoggedIn()`返回false
8. **UI自动显示登录界面**
9. 用户可以重新登录其他账号

## 关键点

1. **使用FLAG_ACTIVITY_CLEAR_TASK**：清除所有Activity栈，确保完全重启
2. **延迟200ms**：确保`TapLoginManager.logout()`完成后再重启
3. **Activity重启后自动检查登录状态**：`remember { mutableStateOf(TapLoginManager.isLoggedIn()) }`会重新执行

## 测试步骤

1. 登录TapTap账号进入游戏
2. 游戏启动后会弹出合规认证对话框（健康游戏提示）
3. 点击"切换账号"按钮
4. **应该返回登录界面，而不是进入游戏**
5. 可以重新登录其他账号

## 修复时间
2025-10-18
