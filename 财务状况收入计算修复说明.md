# 财务状况收入计算修复说明

## 问题描述
玩家反馈财务状况界面的收入数据异常：
- **第1年**：显示正常，收入正确
- **第2年及以后**：收入全部变成 ¥0.00，或者数据对应不上

## 问题根源

### 错误的实现方式
旧代码使用 `dailySalesList` 的**数组索引**来判断年份：

```kotlin
// ❌ 错误：基于索引范围筛选年份
val startIndex = (selectedFinancialYear - 1) * 365
val endIndex = selectedFinancialYear * 365
val yearRevenue = revenue.dailySalesList
    .filterIndexed { index, _ -> index in startIndex until endIndex }
    .sumOf { it.revenue }
```

**错误假设**：
- 假设每年有365条连续记录（第1年：索引0-364，第2年：索引365-729）

**实际情况**：
- `dailySalesList` 只在**玩家运行游戏的那一天**添加记录
- 如果玩家跳过某些天（比如点"下个月"），那些天就不会有记录
- 导致索引范围错误，第2年查询索引365-729时可能根本没有数据

**示例问题**：
1. 玩家第1年只玩了100天 → `dailySalesList` 只有100条记录
2. 玩家跳到第2年 → 代码查找索引365-729
3. **结果**：列表只有100条记录，索引365根本不存在 → 收入¥0.00

## 解决方案

### 正确的实现方式
使用 `DailySales.date` 字段（`java.util.Date`）来判断记录属于哪一年：

```kotlin
// ✅ 正确：基于date字段的实际日期筛选年份
val yearRevenue = revenue.dailySalesList
    .filter { dailySales ->
        // 根据游戏上线日期计算该记录属于游戏的第几年
        val gameYear = calculateGameYear(
            releaseYear = revenue.releaseYear,
            releaseMonth = revenue.releaseMonth,
            releaseDay = revenue.releaseDay,
            recordDate = dailySales.date
        )
        gameYear == selectedFinancialYear
    }
    .sumOf { it.revenue }
```

### 新增辅助函数
在 `FormatUtils.kt` 中添加了 `calculateGameYear` 函数：

```kotlin
/**
 * 根据游戏上线日期和记录日期，计算该记录属于游戏的第几年
 * 
 * @param releaseYear 游戏上线年份
 * @param releaseMonth 游戏上线月份
 * @param releaseDay 游戏上线日期
 * @param recordDate 记录的日期
 * @return 游戏内的年份（1表示第1年，2表示第2年，以此类推）
 */
fun calculateGameYear(
    releaseYear: Int,
    releaseMonth: Int,
    releaseDay: Int,
    recordDate: Date
): Int {
    // 计算从上线日期到记录日期经过的天数
    val daysPassed = ((recordTimeMillis - releaseTimeMillis) / (1000 * 60 * 60 * 24)).toInt()
    
    // 计算游戏内年份（每365天为一年）
    val gameYear = (daysPassed / 365) + 1
    
    return gameYear.coerceAtLeast(1) // 确保至少返回1（第1年）
}
```

## 修改的文件

### 1. FormatUtils.kt
- 添加 `import java.util.Calendar` 和 `import java.util.Date`
- 新增 `calculateGameYear()` 函数

### 2. MainActivity.kt
- 添加 `import com.example.yjcy.utils.calculateGameYear`
- 修改单机游戏收入计算逻辑（第2789-2808行）
- 修改网游收入计算逻辑（第2810-2829行）
- 从基于索引的筛选改为基于日期的筛选

## 修复效果

### 修复前
- 第1年收入：¥14.45M ✅（正确）
- 第2年收入：¥0.00 ❌（错误）

### 修复后
- 第1年收入：¥14.45M ✅
- 第2年收入：正确显示该年实际收入 ✅
- 任意年份都能正确统计 ✅

## 核心改进
1. **不再依赖连续性**：无论玩家是否每天都玩游戏，都能正确计算
2. **基于真实日期**：使用 `Date` 字段的实际日期而不是数组索引
3. **精确计算年份**：根据游戏上线日期和记录日期计算游戏内年份
4. **向后兼容**：旧存档数据自动使用新算法，无需额外处理

## 验证方法
1. 开启一个旧存档（已经第2年或更高）
2. 查看"财务状况"卡片
3. 切换不同年份，验证收入数据是否正确显示
4. 确认不再出现¥0.00的异常情况

## 注意事项
- 该修复完全向后兼容，旧存档无需任何额外操作
- `dailySalesList` 中的 `date` 字段是连续的（每次+1天），即使玩家跳过某些天
- 计算采用整数除法（每365天为一年），与游戏内的年份计算保持一致
