# 游戏版本号显示一致性修复说明

## 问题描述
游戏界面显示的版本号与游戏社区显示的版本号不一致：
- **游戏界面**：显示 `版本V1.8`（使用 `game.version`）
- **游戏社区**：显示 `V8.0 更新`（使用 `update.updateNumber`）

导致玩家困惑，不清楚游戏的实际版本号。

## 问题原因

### 数据结构问题
`GameUpdate` 数据类中只存储了 `updateNumber`（更新次数），没有存储更新时的游戏版本号：
```kotlin
data class GameUpdate(
    val updateNumber: Int,  // 第几次更新（1, 2, 3...）
    // 缺少：版本号字段
    val updateDate: GameDate,
    val updateContent: List<String>,
    val announcement: String,
    val comments: List<PlayerComment> = emptyList()
)
```

### 显示逻辑问题
- **游戏界面**：使用 `game.version` 显示版本号（如 1.8）
- **游戏社区**：使用 `update.updateNumber` 显示版本号（如 8.0）

两者不一致，导致版本号显示混乱。

## 修复方案

### 1. 扩展 `GameUpdate` 数据类
在 `GameUpdate` 中添加 `version` 字段，存储更新时的游戏版本号。

**文件**：`app/src/main/java/com/example/yjcy/data/GameData.kt`

#### 修改内容
```kotlin
data class GameUpdate(
    val updateNumber: Int,  // 第几次更新（1, 2, 3...）
    val version: Float = 1.0f,  // 更新后的游戏版本号（如 1.1, 1.2, 1.3...），默认值用于兼容旧数据
    val updateDate: GameDate,
    val updateContent: List<String>,
    val announcement: String,
    val comments: List<PlayerComment> = emptyList()
) {
    /**
     * 获取显示的版本号
     * 兼容旧数据：如果version是默认值，根据updateNumber计算版本号
     */
    fun getDisplayVersion(): Float {
        return if (version <= 1.0f && updateNumber > 0) {
            // 旧数据：根据更新次数计算版本号（初始版本1.0，每次更新+0.1）
            // 第1次更新 → 1.1，第2次更新 → 1.2，第n次更新 → 1.0 + n * 0.1
            1.0f + updateNumber * 0.1f
        } else {
            version
        }
    }
}
```

### 2. 修改更新记录创建逻辑
在创建更新记录时，保存更新后的游戏版本号。

**文件**：`app/src/main/java/com/example/yjcy/MainActivity.kt`

#### 修改内容
```kotlin
// 创建游戏更新记录
val newUpdateHistory = if (completedTask != null) {
    val updateNumber = (releasedGame.updateHistory ?: emptyList()).size + 1
    val updateDate = GameDate(currentYear, currentMonth, currentDay)
    val newVersion = releasedGame.version + 0.1f // 更新后的版本号
    
    // 创建更新记录
    val gameUpdate = GameUpdate(
        updateNumber = updateNumber,
        version = newVersion, // 保存更新后的版本号
        updateDate = updateDate,
        updateContent = completedTask.features,
        announcement = completedTask.announcement,
        comments = comments
    )
    
    (releasedGame.updateHistory ?: emptyList()) + gameUpdate
}
```

### 3. 修改游戏社区显示逻辑
使用 `update.getDisplayVersion()` 显示版本号，而不是 `update.updateNumber`。

**文件**：`app/src/main/java/com/example/yjcy/ui/GameCommunityDialog.kt`

#### 修改内容
```kotlin
Text(
    text = "V${String.format("%.1f", update.getDisplayVersion())} 更新",
    style = MaterialTheme.typography.titleLarge,
    fontWeight = FontWeight.Bold,
    color = Color(0xFF60A5FA)
)
```

## 修复效果

### 修复前
- **游戏界面**：`版本V1.8`
- **游戏社区**：`V8.0 更新` ❌ 不一致

### 修复后
- **游戏界面**：`版本V1.8`
- **游戏社区**：`V1.8 更新` ✅ 一致

## 版本号计算规则

### 游戏版本号规则
- **初始版本**：1.0
- **每次更新**：版本号 +0.1
- **示例**：
  - 初始发售：V1.0
  - 第1次更新：V1.1
  - 第2次更新：V1.2
  - ...
  - 第8次更新：V1.8

### 兼容性处理
对于旧存档数据（没有 `version` 字段的更新记录）：
- 根据 `updateNumber` 自动计算版本号
- 公式：`1.0 + updateNumber * 0.1`
- 示例：
  - `updateNumber = 1` → `1.0 + 1 * 0.1 = 1.1`
  - `updateNumber = 8` → `1.0 + 8 * 0.1 = 1.8`

## 技术细节

### 数据迁移
- **新数据**：创建更新记录时自动保存版本号
- **旧数据**：通过 `getDisplayVersion()` 方法自动计算版本号
- **无需手动迁移**：兼容性处理确保旧数据正常显示

### 版本号精度
- 版本号使用 `Float` 类型
- 显示时格式化为一位小数：`String.format("%.1f", version)`
- 示例：`1.8` 显示为 `V1.8`

## 修改文件列表

1. **GameData.kt**
   - 第694-715行：添加 `version` 字段和 `getDisplayVersion()` 方法

2. **MainActivity.kt**
   - 第3604行：计算更新后的版本号
   - 第3615行：保存版本号到更新记录

3. **GameCommunityDialog.kt**
   - 第179行：使用 `getDisplayVersion()` 显示版本号

## 总结

本次修复解决了游戏版本号显示不一致的问题：
- ✅ 游戏界面和游戏社区显示的版本号一致
- ✅ 新数据自动保存版本号
- ✅ 旧数据自动兼容，无需手动迁移
- ✅ 版本号显示格式统一（V1.8格式）

现在玩家可以在游戏界面和游戏社区中看到一致的版本号了！



