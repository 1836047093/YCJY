# FPS监测增强说明

## 功能描述

增强FPS监测组件，输出详细的性能诊断日志，帮助定位FPS下降的原因。

## 增强内容

### 1. ✅ 帧间隔统计
记录每一帧的渲染时间，并计算：
- **平均帧时间**：理想值应为16.7ms（60fps）
- **最大帧时间**：找出最卡顿的帧
- **最小帧时间**：最流畅的帧

### 2. ✅ 卡顿帧统计
- 统计超过33ms的帧（低于30fps）
- 计算卡顿帧占比
- 超过30%说明主线程严重阻塞

### 3. ✅ FPS变化检测
- 对比上一秒的FPS值
- 检测剧烈变化（±15帧以上）
- 自动分析可能原因

### 4. ✅ 内存监控
- 显示当前内存使用量
- 计算内存占用百分比
- 超过80%会警告可能触发GC

### 5. ✅ 线程监控
- FPS低于40时输出活跃线程数
- 帮助诊断线程泄漏问题

### 6. ✅ 智能诊断
根据各项指标自动分析FPS下降原因：
- 内存占用过高 → GC导致
- 大量卡顿帧 → 主线程阻塞
- FPS突然暴跌 → 复杂UI绘制或计算

## 日志输出示例

### 正常情况（60fps）
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⏱️ 当前FPS: 59 (➡️ 稳定, 变化: -1)
📊 帧统计: 平均=16.9ms, 最大=18ms, 最小=16ms
⚠️ 卡顿帧: 0/59 (0%)
💾 内存: 125MB/512MB (24%)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 性能下降情况（30fps）
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⏱️ 当前FPS: 28 (📉 大幅下降, 变化: -31)
📊 帧统计: 平均=35.7ms, 最大=150ms, 最小=16ms
⚠️ 卡顿帧: 12/28 (42%)
💾 内存: 380MB/512MB (74%)
🔴 性能警告: FPS低于40帧！
🧵 活跃线程数: 45
⚠️ 检测到严重卡顿帧: 150ms (应小于16.7ms)
⚡ FPS剧烈变化: 59 → 28 (-31)
可能原因: 大量卡顿帧(42%)，主线程可能被阻塞；
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 内存问题情况
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⏱️ 当前FPS: 15 (📉 大幅下降, 变化: -44)
📊 帧统计: 平均=66.7ms, 最大=250ms, 最小=16ms
⚠️ 卡顿帧: 10/15 (66%)
💾 内存: 450MB/512MB (87%)
🔴 性能警告: FPS低于40帧！
🧵 活跃线程数: 52
⚠️ 内存占用过高 (87%)，可能触发GC
⚠️ 检测到严重卡顿帧: 250ms (应小于16.7ms)
⚡ FPS剧烈变化: 59 → 15 (-44)
可能原因: 内存占用过高(87%)，可能触发GC；
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 日志字段说明

### ⏱️ 当前FPS
- 数值：当前帧率
- 状态：稳定/提升/下降
- 变化：相对上一秒的变化量

### 📊 帧统计
- **平均帧时间**：所有帧的平均渲染时间
  - 60fps理想值：16.7ms
  - 30fps理想值：33.3ms
- **最大帧时间**：最慢的一帧
  - >100ms表示严重卡顿
- **最小帧时间**：最快的一帧

### ⚠️ 卡顿帧
- 超过33ms的帧数量（<30fps）
- 卡顿帧占比
- >30%说明严重卡顿

### 💾 内存
- 当前使用/最大内存
- 内存占用百分比
- >80%会触发GC，导致卡顿

### 🧵 活跃线程数
- 仅在FPS<40时输出
- 正常值：20-30个
- >50个可能有线程泄漏

### 可能原因分析

自动分析FPS变化的原因：

| 情况 | 可能原因 |
|------|----------|
| 内存>80% | GC导致卡顿 |
| 卡顿帧>30% | 主线程被阻塞 |
| 最大帧时间>100ms | 复杂的UI绘制或计算 |
| FPS突然暴跌 | 后台任务突然增加 |
| 线程数>50 | 协程/线程泄漏 |

## 使用方法

### 查看详细日志

日志已默认启用（`ENABLE_FPS_LOG = true`），在Logcat中搜索：
```
FPSMonitor
```

### 分析FPS下降

当FPS从59帧突然掉到23帧时，日志会输出：

```
⚡ FPS剧烈变化: 59 → 23 (-36)
可能原因: 大量卡顿帧(45%)，主线程可能被阻塞；
```

然后可以：
1. **查看帧统计** - 找出最大帧时间
2. **查看卡顿帧占比** - 判断是否主线程阻塞
3. **查看内存占用** - 判断是否GC导致
4. **查看线程数** - 判断是否协程泄漏

### 定位具体代码

根据日志时间戳，对照代码执行时间：

**示例：**
```
00:09:53 - FPS: 59 (正常)
00:09:54 - FPS: 23 (下降) ← 这一秒发生了什么？
00:09:55 - FPS: 44 (恢复)
```

可以推断：
- 00:09:54这一秒有耗时操作
- 可能是：
  - 游戏循环的某个计算
  - 网络请求
  - 文件IO
  - GC触发
  - Canvas绘制

## 性能诊断流程

### 步骤1：观察日志模式

**模式A：持续低FPS**
```
FPS: 25 → 28 → 26 → 24 → 27 (持续低于30)
```
**原因：** 持续的性能瓶颈
**解决：** 优化代码，移除复杂操作

**模式B：周期性下降**
```
FPS: 59 → 58 → 25 → 59 → 58 → 24 (每3秒下降一次)
```
**原因：** 定时任务（LaunchedEffect）
**解决：** 优化定时任务，移到后台线程

**模式C：随机尖峰**
```
FPS: 59 → 58 → 3 → 59 → 58 (偶尔暴跌)
```
**原因：** GC或突发的后台任务
**解决：** 减少对象创建，优化内存使用

### 步骤2：查看帧统计

**正常：**
```
平均=16.9ms, 最大=18ms, 最小=16ms
```

**有问题：**
```
平均=35.7ms, 最大=150ms, 最小=16ms
```
→ 最大帧时间150ms说明有严重的主线程阻塞

### 步骤3：查看卡顿帧

**正常：**
```
卡顿帧: 0/59 (0%)
```

**有问题：**
```
卡顿帧: 25/28 (89%)
```
→ 89%的帧都卡顿，主线程严重阻塞

### 步骤4：查看内存

**正常：**
```
内存: 125MB/512MB (24%)
```

**有问题：**
```
内存: 480MB/512MB (93%)
```
→ 内存占用过高，频繁GC

## 已知性能问题和解决方案

### 问题1：主菜单复杂背景动画
- **现象：** 主菜单FPS 20-30帧
- **原因：** 300+次Canvas绘制，303次sin计算/帧
- **解决：** 已移除所有复杂动画 ✅

### 问题2：Supabase同步初始化
- **现象：** 启动卡顿，持续低FPS
- **原因：** 主线程阻塞，后台资源占用
- **解决：** 异步初始化+临时禁用开关 ✅

### 问题3：游戏循环主线程阻塞
- **现象：** 游戏中FPS不稳定
- **原因：** 主线程执行大量计算
- **解决：** 移到后台线程+批量更新 ✅

## 测试建议

1. **编译运行游戏**
2. **在主菜单等待30秒**，观察日志
3. **进入游戏开发几个项目**，观察日志
4. **查看日志输出**，分析性能模式
5. **根据日志定位问题**

## 预期效果

优化后的日志应该显示：
- ✅ FPS稳定在55-60帧
- ✅ 平均帧时间在16-17ms
- ✅ 卡顿帧占比0-5%
- ✅ 内存占用30-50%
- ✅ 无FPS剧烈变化警告

## 版本信息

- **优化日期**: 2025-11-06
- **功能**: FPS监测增强 + 详细性能诊断日志
- **用途**: 帮助定位FPS下降的具体原因




