# 隐私合规整改说明

## 问题描述

根据TapTap隐私合规检测报告，游创纪元 v1.0 版本存在以下问题：

### 问题1：APP在隐私政策同意前收集Android ID
- **问题**：APP以隐私政策弹窗的形式向用户明示收集使用规则，未经用户同意，存在收集Android ID的行为。
- **违规依据**：《个人信息保护法》、GB/T 41391-2022

### 问题2：SDK在隐私政策同意前收集Android ID  
- **问题**：APP向用户明示SDK的收集使用规则，未经用户同意，SDK（TapTap SDK）存在收集Android ID的行为。
- **违规依据**：《个人信息保护法》、GB/T 41391-2022

## 整改方案

### 1. 延迟SDK初始化时机

**修改文件**：`YjcyApplication.kt`

**关键改动**：
- ❌ 移除 `Application.onCreate()` 中的自动 SDK 初始化
- ✅ 添加 `initTapSDKIfNeeded()` 延迟初始化方法
- ✅ 使用 `@Volatile` 标记防止重复初始化

**修改前**：
```kotlin
override fun onCreate() {
    super.onCreate()
    // 直接初始化SDK - 在用户同意隐私政策前
    initTapSDK()
    registerComplianceCallback()
}
```

**修改后**：
```kotlin
override fun onCreate() {
    super.onCreate()
    // 等待用户同意隐私政策后再初始化
    Log.d(TAG, "Application启动完成，等待隐私政策同意后初始化SDK")
}

fun initTapSDKIfNeeded() {
    synchronized(this) {
        if (isSdkInitialized) return
        initTapSDK()
        registerComplianceCallback()
        isSdkInitialized = true
    }
}
```

### 2. 在隐私政策同意后初始化SDK

**修改文件**：`MainActivity.kt`

**关键改动**：
- ✅ 在 `onCreate()` 检查用户是否已同意隐私政策
- ✅ 已同意：立即初始化SDK
- ✅ 未同意：等待用户点击"同意"后初始化
- ✅ 确保合规认证启动前SDK已初始化

**修改代码**：
```kotlin
// 在Activity启动时检查隐私政策同意状态
override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(savedInstanceState)
    
    val sharedPreferences = getSharedPreferences("privacy_settings", MODE_PRIVATE)
    val hasAgreedPrivacy = sharedPreferences.getBoolean("privacy_agreed", false)
    
    // 如果用户已同意隐私政策，则初始化SDK
    if (hasAgreedPrivacy) {
        (application as? YjcyApplication)?.initTapSDKIfNeeded()
        
        // 如果用户已登录，启动合规认证
        if (TapLoginManager.isLoggedIn()) {
            val currentAccount = TapLoginManager.getCurrentAccount()
            currentAccount?.unionId?.let { unionId ->
                TapComplianceManager.startup(this, unionId)
            }
        }
    }
}

// 在隐私政策同意回调中初始化SDK
PrivacyPolicyDialog(
    onAgree = {
        sharedPreferences.edit().apply {
            putBoolean("privacy_agreed", true)
            apply()
        }
        showPrivacyDialog = false
        
        // 用户同意隐私政策后，立即初始化TapSDK
        (application as? YjcyApplication)?.initTapSDKIfNeeded()
    }
)
```

### 3. 更新隐私政策内容

**修改文件**：`MainActivity.kt` - `PrivacyPolicyDialog()`

**关键改动**：
- ✅ 明确说明收集 Android ID 的目的
- ✅ 明确说明收集 Android ID 的方式
- ✅ 明确说明收集 Android ID 的范围
- ✅ 添加 TapTap SDK 的第三方SDK说明

**新增内容**：
```
• 设备信息收集：我们会收集您的Android ID等设备标识符，用于用户账号识别、
  登录认证、防作弊以及为您提供个性化服务。这些信息仅在您同意本隐私政策后才会收集；

第三方SDK说明：
• TapTap SDK：用于提供登录、实名认证和防沉迷服务，会在您同意本隐私政策后
  收集Android ID等设备信息，用于账号识别和合规认证。
```

## 整改效果

### 修改前的执行流程
```
1. 用户启动APP
2. Application.onCreate() 自动初始化TapTap SDK ❌
3. SDK收集Android ID ❌
4. 显示隐私政策弹窗
5. 用户同意隐私政策
```

### 修改后的执行流程
```
1. 用户启动APP
2. Application.onCreate() 不初始化SDK ✅
3. 显示隐私政策弹窗
4. 用户同意隐私政策
5. 立即初始化TapTap SDK ✅
6. SDK开始收集Android ID ✅（在用户同意后）
```

## 测试验证步骤

### 1. 清空测试环境
```bash
# 卸载并重新安装APP
adb uninstall com.example.yjcy
adb install app-debug.apk
```

### 2. 首次启动验证
- ✅ 启动APP，应立即显示隐私政策弹窗
- ✅ 此时TapTap SDK未初始化（查看Logcat日志）
- ✅ 点击"同意"后，SDK立即初始化
- ✅ 初始化完成后可以正常使用TapTap登录

### 3. 重启APP验证
- ✅ 关闭并重新启动APP
- ✅ 不显示隐私政策弹窗（已同意）
- ✅ SDK在Activity.onCreate()中自动初始化
- ✅ TapTap登录功能正常

### 4. Logcat日志验证
查找以下关键日志：
```
# 首次启动
YjcyApplication: Application启动完成，等待隐私政策同意后初始化SDK
MainActivity: 用户未同意隐私政策，等待用户同意后再初始化SDK
# 用户点击同意后
YjcyApplication: TapSDK延迟初始化完成（用户已同意隐私政策）

# 重启APP（已同意）
YjcyApplication: Application启动完成，等待隐私政策同意后初始化SDK
MainActivity: TapSDK延迟初始化完成（用户已同意隐私政策）
```

## 合规性检查清单

- [x] SDK初始化在用户同意隐私政策**之后**
- [x] 隐私政策中明确说明收集Android ID的**目的**
- [x] 隐私政策中明确说明收集Android ID的**方式**
- [x] 隐私政策中明确说明收集Android ID的**范围**
- [x] 隐私政策中说明第三方SDK（TapTap SDK）的信息收集行为
- [x] 已同意隐私政策的用户，重启APP时SDK自动初始化
- [x] 未同意隐私政策的用户，无法使用游戏功能

## 注意事项

1. **不要删除 `privacy_settings` SharedPreferences**
   - 存储了用户的隐私政策同意状态
   - 删除后会导致用户需要重新同意

2. **正式发布时关闭日志**
   - 修改 `YjcyApplication.kt` 中的 `enableLog = false`

3. **更新线上隐私政策文档**
   - 确保链接 `https://share.note.youdao.com/s/KjmsBvUB` 中的内容与APP内显示一致
   - 添加关于Android ID收集的详细说明

4. **重新提交审核**
   - 提交到TapTap审核时，说明已完成整改
   - 提供本整改说明文档作为附件

## 参考文档

- [TapTap隐私安全问题合规指引](https://taptap.feishu.cn/docx/OydUdi8SooWhUKxd6MIczOGTnDf)
- [GB/T 41391-2022 移动互联网应用程序（App）收集个人信息基本要求](https://openstd.samr.gov.cn/bzgk/gb/newGbInfo?hcno=42E6B8DF87F6A0B8B44E6DEBB6FBACFE)
- [个人信息保护法](http://www.npc.gov.cn/npc/c30834/202108/a8c4e3672c74491a80b53a172bb753fe.shtml)

---

**整改完成时间**：2024-10-19  
**整改版本**：v1.1  
**整改负责人**：开发团队
