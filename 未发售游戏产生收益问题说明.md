# 未发售游戏产生收益问题说明

## 问题描述

用户反映：没有游戏在发售，但资金在增长，还解锁了销量成就。

从截图看到：
- 资金：¥124.11M（在增长）
- 解锁成就："全民热玩"（单款游戏销量突破500万）
- 两款游戏显示在"已发售"标签下

## 问题原因分析

### 可能原因1：旧存档的继承游戏（最可能）⚠️

从"继承游戏需要手动发售功能说明.md"可知：

**旧版本（修复前）：**
```kotlin
// 收购竞争对手时，继承的游戏直接设置为RELEASED
releaseStatus = GameReleaseStatus.RELEASED  // ❌ 自动发售
```

**新版本（修复后）：**
```kotlin
// 继承的游戏设置为RATED，需要玩家手动发售
releaseStatus = GameReleaseStatus.RATED  // ✅ 需要手动发售
```

**如果您使用的是旧存档：**
- 存档中的继承游戏状态仍然是`RELEASED`
- 这些游戏会自动产生收益
- 显示在"已发售"标签下

### 可能原因2：您确实点过发售按钮

可能您之前：
1. 开发完成了游戏
2. 点击了"发售"按钮
3. 游戏已经上架销售
4. 但您忘记了

### 可能原因3：存档数据异常

存档读取时可能出现数据异常，导致游戏状态错误。

## 诊断方法

### 方法1：检查游戏ID

1. 重新运行游戏
2. 打开Logcat
3. 搜索：`💰 发售中的游戏`

**如果看到：**
```
💰 发售中的游戏: 狂战传说 (状态=RELEASED, 继承游戏=true)
💰 发售中的游戏: 极限传奇 (状态=RELEASED, 继承游戏=true)
```

说明这些是**旧存档的继承游戏**，它们在旧版本中被自动发售了。

**如果看到：**
```
💰 发售中的游戏: 狂战传说 (状态=RELEASED, 继承游戏=false)
```

说明这些是**您自己开发并发售的游戏**。

### 方法2：检查游戏列表

进入"项目管理"：
- **已发售**标签：查看有哪些游戏
- **子公司游戏**标签：查看是否有继承游戏

如果"已发售"和"子公司游戏"中有相同的游戏，说明是继承游戏被发售了。

### 方法3：检查收益来源

1. 点击游戏卡片上的"收益报告"按钮
2. 查看销量数据
3. 检查发售日期

如果发售日期很早（如第1年），但您现在已经是第2年，说明这个游戏确实一直在发售中。

## 解决方案

### 方案1：下架不需要的游戏（推荐）

如果您不想让这些游戏产生收益：
1. 进入"项目管理" → "已发售"
2. 找到不需要的游戏
3. 点击"下架"按钮（如果有）
4. 游戏停止产生收益

### 方案2：开启新游戏

如果是旧存档的历史遗留问题：
1. 开启新的游戏存档
2. 从头开始，避免旧数据干扰
3. 新版本中继承游戏需要手动发售

### 方案3：接受现状

如果游戏确实是您发售的：
- 这些收益是正常的
- 成就解锁也是正常的
- 可以继续游戏

## 收益计算逻辑（代码验证）

### 只有RELEASED状态才产生收益

文件：`MainActivity.kt` - 第2340-2373行

```kotlin
// 每天更新已发售游戏的收益
val releasedGames = games.filter { 
    it.releaseStatus == GameReleaseStatus.RELEASED ||  // 已发售
    it.releaseStatus == GameReleaseStatus.RATED        // ❌ 错误！RATED不应该产生收益
}

if (!isPaused) {
    releasedGames.forEach { releasedGame ->
        // 计算每日收益
        val dailyRevenue = RevenueManager.addDailyRevenueForGame(...)
        money += dailyRevenue.toLong()  // ← 这里增加资金
    }
}
```

**发现Bug！**

代码中将`RATED`状态的游戏也包含在收益计算中！这是不对的！

### 修复：移除RATED状态的收益计算

RATED状态表示"已评分但未发售"，不应该产生收益。

只有`RELEASED`状态才应该产生收益！

## 下一步操作

我已经添加了调试日志，请：

1. **重新运行游戏**
2. **等待到月初（X月1日）**
3. **查看Logcat日志**，搜索：`💰 发售中的游戏`
4. **截图日志给我**

我会根据日志判断：
- 这些游戏是继承游戏吗？
- 它们的状态是什么？
- 为什么会产生收益？

然后我会修复这个bug。

## 临时验证方法

### 检查游戏ID
1. 进入开发完成的游戏详情
2. 如果游戏ID以`inherited_`开头 → 继承游戏
3. 如果不是 → 您自己开发的游戏

### 检查发售按钮
1. 点击游戏卡片
2. 如果显示"发售"按钮 → 未发售
3. 如果显示"收益报告"按钮 → 已发售

## 已添加的调试日志

```kotlin
// 每月1日输出发售游戏信息
💰 发售中的游戏: XX (状态=RELEASED/RATED, 继承游戏=true/false)
```

这个日志会帮助我们确认问题根源。

## 修改文件
- `app/src/main/java/com/example/yjcy/MainActivity.kt`（添加调试日志）
- `未发售游戏产生收益问题说明.md`（本文档）











