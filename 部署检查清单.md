# 完整部署检查清单

## ✅ 部署前准备

- [ ] 已安装Node.js 18.x LTS
- [ ] 已安装MySQL 8.0
- [ ] MySQL服务正在运行
- [ ] 知道MySQL root密码
- [ ] 已准备好API数据库用户密码

## ✅ 执行部署脚本

- [ ] 以管理员身份打开PowerShell
- [ ] 执行 `auto-deploy.ps1` 脚本
- [ ] 输入MySQL root密码
- [ ] 输入API数据库用户密码
- [ ] 等待脚本完成

## ✅ 部署后验证

### 1. 检查服务状态
```powershell
pm2 list
# 应该看到 redeem-api 状态为 online
```

### 2. 检查日志
```powershell
pm2 logs redeem-api
# 应该看到 "兑换码API服务运行在端口 3000"
```

### 3. 本地测试
```powershell
curl http://localhost:3000/health
# 应该返回: {"status":"ok","timestamp":"..."}
```

### 4. 检查数据库
```powershell
# 登录MySQL
mysql -u root -p
USE redeem_codes;
SELECT COUNT(*) FROM redeem_codes;
# 应该返回 151（150个支持者 + 1个GM）
```

### 5. 测试API接口
```powershell
# 查询兑换码
curl http://localhost:3000/api/v1/redeem/code/SUPPORTER001

# 应该返回JSON数据
```

## ✅ 配置阿里云安全组

- [ ] 登录阿里云控制台
- [ ] 进入ECS实例 → 安全组
- [ ] 添加入站规则：端口3000，协议TCP，授权0.0.0.0/0
- [ ] 保存规则

## ✅ 公网测试

```powershell
# 从你的电脑测试
curl http://8.138.186.224:3000/health
# 应该返回JSON数据
```

## ✅ Android客户端配置

- [ ] 修改 `DomesticRedeemCodeManager.kt`
- [ ] 设置 `BASE_URL = "http://8.138.186.224:3000/api/v1/redeem"`
- [ ] 编译并测试Android应用

## 🔍 故障排查

### 问题1：pm2服务未启动
```powershell
# 查看日志
pm2 logs redeem-api

# 常见原因：
# - .env文件中的数据库密码错误
# - MySQL服务未运行
# - 端口3000被占用
```

### 问题2：无法连接数据库
```powershell
# 测试MySQL连接
mysql -u redeem_api -p
# 输入密码，应该能登录

# 检查.env文件
cat C:\redeem-api\.env
# 确认密码正确
```

### 问题3：外网无法访问
```powershell
# 检查Windows防火墙
Get-NetFirewallRule -DisplayName "Redeem API"

# 检查阿里云安全组（在控制台检查）

# 检查服务是否监听0.0.0.0
netstat -an | findstr 3000
# 应该看到 0.0.0.0:3000
```

### 问题4：兑换码数据未初始化
```powershell
# 手动运行初始化脚本
cd C:\redeem-api
python init_codes.py

# 或使用MySQL命令行
mysql -u root -p redeem_codes
# 然后手动插入数据
```

## 📞 需要帮助？

如果遇到问题，请提供：
1. 错误信息（完整日志）
2. 执行到哪一步
3. pm2 logs的输出

我可以帮你快速定位问题！

