# è´¢åŠ¡çŠ¶å†µæ”¶å…¥è®¡ç®—ä¿®å¤è¯´æ˜2.0

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼šè´¢åŠ¡çŠ¶å†µç•Œé¢æ˜¾ç¤ºç¬¬3å¹´çš„å•æœºæ”¶å…¥ã€ç½‘æ¸¸æ”¶å…¥ã€æ€»æ”¶å…¥éƒ½ä¸ºÂ¥0.00ï¼Œä½†è¯¦ç»†ç»Ÿè®¡æ˜¾ç¤ºæ€»æ”¶å…¥ä¸ºÂ¥1.30Mã€‚

## é—®é¢˜æ ¹æº

**æ—¥æœŸç³»ç»Ÿæ··ä¹±**ï¼š`DailySales.date` ä½¿ç”¨çš„æ˜¯**ç³»ç»Ÿæ—¶é—´**ï¼ˆç”µè„‘å®é™…æ—¶é—´ï¼‰ï¼Œè€Œè´¢åŠ¡çŠ¶å†µè®¡ç®—ä½¿ç”¨çš„æ˜¯**æ¸¸æˆå†…æ—¶é—´**ï¼ˆå¦‚ç¬¬3å¹´1æœˆ1æ—¥ï¼‰ï¼Œä¸¤è€…å®Œå…¨ä¸åŒ¹é…ï¼

### å…·ä½“é—®é¢˜ç‚¹

1. **generateRevenueData å‡½æ•°**ï¼ˆline 535-537ï¼‰ï¼š
   ```kotlin
   val calendar = Calendar.getInstance()
   calendar.add(Calendar.DAY_OF_YEAR, -daysOnMarket)
   val releaseDate = calendar.time  // ä½¿ç”¨ç³»ç»Ÿå½“å‰æ—¶é—´ï¼
   ```

2. **addDailyRevenueForGame å‡½æ•°**ï¼ˆline 1017ï¼‰ï¼š
   ```kotlin
   val firstDayDate = currentGameRevenue.releaseDate  // ç³»ç»Ÿæ—¶é—´
   ```

3. **åç»­å¤©æ•°è®¡ç®—**ï¼ˆline 1109-1112ï¼‰ï¼š
   ```kotlin
   val calendar = Calendar.getInstance()
   calendar.time = latestSales.date  // åŸºäºç³»ç»Ÿæ—¶é—´çš„å‰ä¸€å¤©
   calendar.add(Calendar.DAY_OF_YEAR, 1)
   ```

4. **è´¢åŠ¡çŠ¶å†µè®¡ç®—**ï¼ˆMainActivity line 3419-3425ï¼‰ï¼š
   ```kotlin
   val gameYear = calculateGameYear(
       releaseYear = 3,        // æ¸¸æˆå†…æ—¶é—´
       releaseMonth = 1,       // æ¸¸æˆå†…æ—¶é—´
       releaseDay = 1,         // æ¸¸æˆå†…æ—¶é—´
       recordDate = dailySales.date  // ç³»ç»Ÿæ—¶é—´ï¼ˆ2024-10-27ï¼‰
   )
   // è®¡ç®—å¤©æ•°å·® = (2024-10-27) - (3-1-1) = å·¨å¤§çš„æ•°å­—
   // gameYear = å·¨å¤§æ•°å­— / 365 + 1 = è¿œè¶…ç¬¬3å¹´
   // æ‰€ä»¥ç­›é€‰ç¬¬3å¹´çš„è®°å½•æ—¶ï¼Œæ‰¾ä¸åˆ°ä»»ä½•æ•°æ®
   ```

## ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®æ”¹ addDailyRevenueForGame - é¦–æ—¥é”€é‡

```kotlin
// æ—§ä»£ç ï¼ˆé”™è¯¯ï¼‰
val firstDayDate = currentGameRevenue.releaseDate

// æ–°ä»£ç ï¼ˆæ­£ç¡®ï¼‰
val calendar = Calendar.getInstance()
calendar.set(Calendar.YEAR, currentGameRevenue.releaseYear)
calendar.set(Calendar.MONTH, currentGameRevenue.releaseMonth - 1)
calendar.set(Calendar.DAY_OF_MONTH, currentGameRevenue.releaseDay)
calendar.set(Calendar.HOUR_OF_DAY, 0)
calendar.set(Calendar.MINUTE, 0)
calendar.set(Calendar.SECOND, 0)
calendar.set(Calendar.MILLISECOND, 0)
val firstDayDate = calendar.time
```

### 2. ä¿®æ”¹ addDailyRevenueForGame - åç»­å¤©æ•°

```kotlin
// æ—§ä»£ç ï¼ˆé”™è¯¯ï¼‰
val calendar = Calendar.getInstance()
calendar.time = latestSales.date
calendar.add(Calendar.DAY_OF_YEAR, 1)

// æ–°ä»£ç ï¼ˆæ­£ç¡®ï¼‰
val calendar = Calendar.getInstance()
calendar.set(Calendar.YEAR, currentYear)
calendar.set(Calendar.MONTH, currentMonth - 1)
calendar.set(Calendar.DAY_OF_MONTH, currentDay)
calendar.set(Calendar.HOUR_OF_DAY, 0)
calendar.set(Calendar.MINUTE, 0)
calendar.set(Calendar.SECOND, 0)
calendar.set(Calendar.MILLISECOND, 0)
val newDate = calendar.time
```

### 3. ä¿®æ”¹ generateRevenueData - å†å²æ•°æ®

```kotlin
// æ—§ä»£ç ï¼ˆé”™è¯¯ï¼‰
val calendar = Calendar.getInstance()
calendar.add(Calendar.DAY_OF_YEAR, -daysOnMarket)
val releaseDate = calendar.time

// æ–°ä»£ç ï¼ˆæ­£ç¡®ï¼‰
val calendar = Calendar.getInstance()
calendar.set(Calendar.YEAR, releaseYear)
calendar.set(Calendar.MONTH, releaseMonth - 1)
calendar.set(Calendar.DAY_OF_MONTH, releaseDay)
calendar.set(Calendar.HOUR_OF_DAY, 0)
calendar.set(Calendar.MINUTE, 0)
calendar.set(Calendar.SECOND, 0)
calendar.set(Calendar.MILLISECOND, 0)
val releaseDate = calendar.time

// å†å²æ•°æ®ä¹Ÿä½¿ç”¨æ¸¸æˆå†…æ—¶é—´
for (i in 0 until daysOnMarket) {
    val dayCalendar = Calendar.getInstance()
    dayCalendar.time = releaseDate
    dayCalendar.add(Calendar.DAY_OF_YEAR, i)
    val date = dayCalendar.time
    // ...
}
```

### 4. æ–°å¢æ•°æ®è¿ç§»å‡½æ•°

ä¸ºäº†ä¿®å¤å·²æœ‰å­˜æ¡£çš„æ•°æ®ï¼Œæ·»åŠ äº† `migrateDateToGameTime()` å‡½æ•°ï¼š

```kotlin
fun migrateDateToGameTime() {
    // æ£€æŸ¥æ¯ä¸ªæ¸¸æˆçš„ DailySales.date æ˜¯å¦ä½¿ç”¨ç³»ç»Ÿæ—¶é—´
    gameRevenueMap.forEach { (gameId, revenue) ->
        val firstDate = revenue.dailySalesList.first().date
        val firstYear = Calendar.getInstance().apply { time = firstDate }.get(Calendar.YEAR)
        
        if (firstYear != revenue.releaseYear) {
            // éœ€è¦è¿ç§»ï¼šæ ¹æ®ç´¢å¼•é‡å»ºæ¸¸æˆå†…æ—¥æœŸ
            val migratedDailySales = revenue.dailySalesList.mapIndexed { index, dailySales ->
                val calendar = Calendar.getInstance()
                calendar.set(Calendar.YEAR, revenue.releaseYear)
                calendar.set(Calendar.MONTH, revenue.releaseMonth - 1)
                calendar.set(Calendar.DAY_OF_MONTH, revenue.releaseDay)
                calendar.add(Calendar.DAY_OF_YEAR, index)
                
                dailySales.copy(date = calendar.time)
            }
            
            // æ›´æ–°æ•°æ®
            gameRevenueMap[gameId] = revenue.copy(
                releaseDate = migratedDailySales.first().date,
                dailySalesList = migratedDailySales
            )
        }
    }
    
    saveRevenueData()
}
```

åœ¨ `MainActivity.onCreate` ä¸­è°ƒç”¨ï¼ˆline 176ï¼‰ï¼š
```kotlin
RevenueManager.initialize(this)
RevenueManager.migrateDateToGameTime()  // ä¸€æ¬¡æ€§è¿ç§»
```

## ä¿®æ”¹çš„æ–‡ä»¶

1. **GameRevenueData.kt**ï¼š
   - `addDailyRevenueForGame()` - é¦–æ—¥å’Œåç»­å¤©æ•°çš„æ—¥æœŸåˆ›å»ºï¼ˆline 1017-1026, 1109-1118ï¼‰
   - `generateRevenueData()` - å†å²æ•°æ®çš„æ—¥æœŸåˆ›å»ºï¼ˆline 535-553ï¼‰
   - `migrateDateToGameTime()` - æ–°å¢æ•°æ®è¿ç§»å‡½æ•°ï¼ˆline 1882-1944ï¼‰

2. **MainActivity.kt**ï¼š
   - `onCreate()` - è°ƒç”¨æ•°æ®è¿ç§»ï¼ˆline 176ï¼‰

## ä¿®å¤æ•ˆæœ

âœ… **æ–°å‘å”®çš„æ¸¸æˆ**ï¼šæ‰€æœ‰æ—¥æœŸä½¿ç”¨æ¸¸æˆå†…æ—¶é—´ï¼Œè´¢åŠ¡çŠ¶å†µæ­£ç¡®æ˜¾ç¤º  
âœ… **æ—§å­˜æ¡£æ¸¸æˆ**ï¼šè‡ªåŠ¨è¿ç§»æ—¥æœŸï¼Œè´¢åŠ¡çŠ¶å†µæ¢å¤æ­£å¸¸æ˜¾ç¤º  
âœ… **å‘åå…¼å®¹**ï¼šè¿ç§»æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œä¸ä¼šé‡å¤æ‰§è¡Œ  
âœ… **æ•°æ®å®‰å…¨**ï¼šåªä¿®æ”¹æ—¥æœŸï¼Œä¿ç•™æ‰€æœ‰é”€é‡å’Œæ”¶ç›Šæ•°æ®  

## éªŒè¯æ–¹æ³•

1. å¯åŠ¨æ¸¸æˆï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š
   ```
   RevenueManager: ===== å¼€å§‹æ•°æ®è¿ç§»ï¼šä¿®å¤DailySalesæ—¥æœŸ =====
   RevenueManager: æ¸¸æˆ æ°¸æ’ä¹‹å¤œ éœ€è¦è¿ç§»ï¼Œå…± 70 æ¡è®°å½•
   RevenueManager:   âœ“ å·²è¿ç§»ï¼šé¦–æ—¥ä» Sun Oct 27 2024 æ”¹ä¸º Wed Jan 01 0003
   RevenueManager: ===== æ•°æ®è¿ç§»å®Œæˆï¼Œå…±è¿ç§» 1 ä¸ªæ¸¸æˆ =====
   ```

2. æ‰“å¼€"ğŸ¢å…¬å¸æ¦‚è§ˆ" â†’ "è´¢åŠ¡çŠ¶å†µ"ï¼Œé€‰æ‹©ç¬¬3å¹´
3. åº”è¯¥èƒ½çœ‹åˆ°æ­£ç¡®çš„å•æœºæ”¶å…¥ã€ç½‘æ¸¸æ”¶å…¥å’Œæ€»æ”¶å…¥

4. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤è®¡ç®—è¿‡ç¨‹ï¼š
   ```
   MainActivity: è´¢åŠ¡çŠ¶å†µè®¡ç®—å®Œæˆï¼ˆç¬¬3å¹´ï¼‰ï¼šå•æœºÂ¥123456.78 + ç½‘æ¸¸Â¥654321.09 = æ€»æ”¶å…¥Â¥777777.87
   ```

## æŠ€æœ¯è¯´æ˜

### ä¸ºä»€ä¹ˆä½¿ç”¨æ¸¸æˆå†…æ—¶é—´ï¼Ÿ

1. **ä¸šåŠ¡é€»è¾‘ä¸€è‡´æ€§**ï¼šæ¸¸æˆä¸­çš„å¹´ä»½æ¦‚å¿µæ˜¯æ¸¸æˆå†…æ—¶é—´ï¼ˆç¬¬1å¹´ã€ç¬¬2å¹´ï¼‰ï¼Œè€Œä¸æ˜¯å®é™…å¹´ä»½ï¼ˆ2024å¹´ï¼‰
2. **è´¢åŠ¡çŠ¶å†µè®¡ç®—**ï¼šæŒ‰æ¸¸æˆå†…å¹´ä»½ç»Ÿè®¡æ”¶å…¥ï¼Œéœ€è¦æ—¥æœŸä¸æ¸¸æˆå†…æ—¶é—´å¯¹åº”
3. **è·¨è®¾å¤‡å…¼å®¹**ï¼šä¸åŒè®¾å¤‡çš„ç³»ç»Ÿæ—¶é—´å¯èƒ½ä¸åŒï¼Œä½†æ¸¸æˆå†…æ—¶é—´æ˜¯ç»Ÿä¸€çš„

### Calendar.MONTH æ³¨æ„äº‹é¡¹

Java Calendar çš„æœˆä»½ä»0å¼€å§‹ï¼ˆ0=1æœˆï¼Œ11=12æœˆï¼‰ï¼Œæ‰€ä»¥éœ€è¦ `-1`ï¼š
```kotlin
calendar.set(Calendar.MONTH, releaseMonth - 1)
```

### è¿ç§»æ£€æµ‹é€»è¾‘

é€šè¿‡æ¯”è¾ƒ `DailySales.first().date` çš„å¹´ä»½ä¸ `releaseYear` æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦è¿ç§»ï¼š
- å¦‚æœç›¸åŒï¼šå·²ä½¿ç”¨æ¸¸æˆå†…æ—¶é—´ï¼Œæ— éœ€è¿ç§»
- å¦‚æœä¸åŒï¼šä½¿ç”¨äº†ç³»ç»Ÿæ—¶é—´ï¼ˆå¦‚2024å¹´ï¼‰ï¼Œéœ€è¦è¿ç§»

## ä¸ä¹‹å‰ä¿®å¤çš„å…³ç³»

ä¹‹å‰çš„ä¿®å¤ï¼ˆ`calculateGameYear` å‡½æ•°ï¼‰æ­£ç¡®å®ç°äº†**æ—¥æœŸè®¡ç®—é€»è¾‘**ï¼Œä½†æ²¡æœ‰è§£å†³**æ—¥æœŸæ•°æ®æœ¬èº«é”™è¯¯**çš„é—®é¢˜ã€‚

- **ä¹‹å‰çš„é—®é¢˜**ï¼šä½¿ç”¨ç´¢å¼•åˆ¤æ–­å¹´ä»½ï¼ˆé”™è¯¯ï¼‰
- **ä¹‹å‰çš„è§£å†³**ï¼šä½¿ç”¨æ—¥æœŸè®¡ç®—å¹´ä»½ï¼ˆæ­£ç¡®ï¼‰
- **æœ¬æ¬¡çš„é—®é¢˜**ï¼šæ—¥æœŸæ•°æ®ä½¿ç”¨ç³»ç»Ÿæ—¶é—´ï¼ˆé”™è¯¯ï¼‰
- **æœ¬æ¬¡çš„è§£å†³**ï¼šæ—¥æœŸæ•°æ®ä½¿ç”¨æ¸¸æˆå†…æ—¶é—´ï¼ˆæ­£ç¡®ï¼‰

ä¸¤æ¬¡ä¿®å¤æ˜¯äº’è¡¥çš„ï¼š
1. ç¬¬ä¸€æ¬¡ç¡®ä¿äº†è®¡ç®—æ–¹æ³•æ­£ç¡®
2. ç¬¬äºŒæ¬¡ç¡®ä¿äº†æ•°æ®æºæ­£ç¡®

## é¢„é˜²æªæ–½

ä»¥ååˆ›å»ºä»»ä½•ä¸æ¸¸æˆæ—¶é—´ç›¸å…³çš„ Date å¯¹è±¡æ—¶ï¼Œ**å¿…é¡»ä½¿ç”¨æ¸¸æˆå†…æ—¶é—´**ï¼š

```kotlin
// âŒ é”™è¯¯ç¤ºèŒƒ
val date = Date()  // ç³»ç»Ÿå½“å‰æ—¶é—´
val calendar = Calendar.getInstance()  // å½“å‰æ—¶é—´

// âœ… æ­£ç¡®ç¤ºèŒƒ
val calendar = Calendar.getInstance()
calendar.set(Calendar.YEAR, currentYear)
calendar.set(Calendar.MONTH, currentMonth - 1)
calendar.set(Calendar.DAY_OF_MONTH, currentDay)
// ... è®¾ç½®æ—¶åˆ†ç§’ä¸º0
val date = calendar.time
```

## æ€»ç»“

è¿™æ˜¯ä¸€ä¸ª**æ•°æ®æºé”™è¯¯**å¯¼è‡´çš„bugï¼Œå³ä½¿è®¡ç®—é€»è¾‘æ­£ç¡®ï¼Œå¦‚æœè¾“å…¥æ•°æ®é”™è¯¯ï¼Œç»“æœä¹Ÿä¼šé”™è¯¯ã€‚é€šè¿‡ç»Ÿä¸€ä½¿ç”¨æ¸¸æˆå†…æ—¶é—´ï¼Œå½»åº•è§£å†³äº†è´¢åŠ¡çŠ¶å†µè®¡ç®—çš„é—®é¢˜ã€‚

---

**ä¿®å¤æ—¥æœŸ**: 2024-10-27  
**å½±å“ç‰ˆæœ¬**: æ‰€æœ‰åŒ…å«è´¢åŠ¡çŠ¶å†µåŠŸèƒ½çš„ç‰ˆæœ¬  
**ä¿®å¤ç‰ˆæœ¬**: ä¸‹ä¸€ä¸ªå‘å¸ƒç‰ˆæœ¬
