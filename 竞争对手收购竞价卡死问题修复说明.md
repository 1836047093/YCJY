# 竞争对手收购竞价卡死问题修复说明

## 问题描述

玩家在收购竞争对手时，会出现卡在竞价过程的情况，界面显示"等待中..."但无法继续进行，只能强制退出。

## 问题原因

代码中存在**并发执行导致的死锁问题**。具体原因如下：

### 并发执行路径

在`CompetitorScreen.kt`的`AcquisitionDialog`组件中，`LaunchedEffect`同时监听`eligibilityStatus`和`triggerAIBidding`两个状态变化。存在两个独立的AI竞价处理路径：

1. **初始AI竞价路径**（第1872-1876行）：
   - 竞价开始时，如果有竞争对手参与，延迟2秒后调用`processAIRound()`
   - `processAIRound()`会处理AI出价，然后倒计时5秒，再**递归调用**自己
   - 这个递归会一直持续，直到没有AI出价为止

2. **玩家加价触发的AI竞价路径**（第1879-1889行）：
   - 每次玩家加价时，`triggerAIBidding++`
   - `LaunchedEffect`检测到变化，执行倒计时5秒后调用`processAIRound()`

### 死锁场景

这两个路径会导致**两个并发的`processAIRound()`调用同时运行**：

1. 初始AI竞价启动并进入递归循环
2. AI加价后进入倒计时（5秒）
3. 此时玩家加价，触发第二个AI竞价路径
4. 第二个路径也开始倒计时并调用`processAIRound()`
5. 两个并发调用相互干扰，导致状态混乱
6. 可能出现`biddingPhase`被设置为"finished"但界面仍显示"等待中..."的情况
7. 玩家无法操作，卡死

## 解决方案

### 核心修复

添加`isProcessingAIBidding`布尔标志，防止并发执行：

```kotlin
// AI竞价处理中标志（防止并发执行）
var isProcessingAIBidding by remember { mutableStateOf(false) }
```

### 修改点

1. **在`processAIRound()`函数开始时检查标志**（第1772-1776行）：
```kotlin
suspend fun processAIRound() {
    // 防止并发执行
    if (isProcessingAIBidding) {
        return
    }
    isProcessingAIBidding = true
    // ... 后续逻辑
}
```

2. **在递归调用前重置标志**（第1802行）：
```kotlin
countdown = 0
isProcessingAIBidding = false // 在递归前重置标志
processAIRound()
```

3. **在竞价结束时重置标志**（第1806行）：
```kotlin
// 竞价结束
isProcessingAIBidding = false // 重置标志
biddingPhase = "finished"
```

4. **在玩家加价触发逻辑中检查标志**（第1881行）：
```kotlin
// 玩家加价后触发AI竞价（固定5秒延迟，并显示倒计时）
// 但如果AI竞价已在处理中，则跳过以避免并发
if (triggerAIBidding > 0 && biddingPhase == "bidding" && !isProcessingAIBidding) {
    // ... 启动新的AI竞价
}
```

## 修复效果

- ✅ 防止多个`processAIRound()`并发执行
- ✅ 避免状态混乱导致的卡死
- ✅ 确保竞价流程正常进行
- ✅ 保证玩家可以正常操作或退出竞价

## 工作流程（修复后）

1. 竞价初始化，如果有竞争对手，启动AI竞价
2. `isProcessingAIBidding`设置为`true`
3. AI竞价持续运行（递归调用），直到没有AI出价
4. 如果玩家在AI竞价期间加价：
   - `triggerAIBidding`增加，但因为`isProcessingAIBidding=true`
   - 新的AI竞价不会启动，避免并发
   - 已运行的AI竞价会继续，并检测到新的价格
5. 当没有AI出价时：
   - `isProcessingAIBidding`重置为`false`
   - `biddingPhase`设置为"finished"
   - 显示竞价结果

## 注意事项

- 此修复解决了并发执行导致的卡死问题
- 如果仍遇到问题，可能是其他原因，需要进一步排查
- 建议测试各种场景：
  - 无竞争对手的收购
  - 有竞争对手但玩家一直不加价
  - 玩家频繁加价
  - 资金不足时的收购

## 修改文件

- `app/src/main/java/com/example/yjcy/ui/CompetitorScreen.kt`
  - 添加`isProcessingAIBidding`标志（第1742行）
  - 修改`processAIRound()`函数（第1772-1806行）
  - 修改玩家加价触发逻辑（第1881行）

## 向后兼容

此修复完全向后兼容，不影响存档数据，不需要用户重新开档。
