# 财务状况年份选择功能说明

## 功能概述

在公司概览界面的**财务状况**卡片右上角新增了年份下拉选择器，玩家可以选择不同年份查看对应年份的财务数据。

## 核心功能

### 1. 年份选择下拉框

**位置**：财务状况标题栏右侧

**功能**：
- 显示当前选择的年份（如"第3年"）
- 点击展开下拉菜单
- 支持从第1年到当前游戏年份的所有年份选择
- 默认显示当前年份的数据

**UI特性**：
- 下拉按钮样式：白色半透明背景，带边框
- 下拉菜单背景：深色（#1F2937）
- 选中年份：橙色高亮（#F59E0B）+ 粗体
- 下拉箭头：展开时向上▲，折叠时向下▼
- 年份列表：从最新年份到第1年倒序排列

### 2. 财务数据按年份统计

**统计维度**：
- **单机收入**：该年所有单机游戏的收入总和
- **网游收入**：该年所有网络游戏的收入总和
- **总收入**：单机收入 + 网游收入

**计算逻辑**：
- 每365天为一个游戏年度
- 第1年：第0-364天的数据
- 第2年：第365-729天的数据
- 第N年：第(N-1)×365 到 N×365-1天的数据

### 3. 实时切换

**交互流程**：
1. 玩家点击"第X年"按钮
2. 下拉菜单展开显示所有可选年份
3. 玩家选择目标年份
4. 菜单自动关闭
5. 财务数据立即更新为所选年份的数据

## 技术实现

### 核心组件

**CompanyInfoCardWithYearSelector**

新增的带年份选择器的公司信息卡片组件，包含以下参数：

```kotlin
@Composable
fun CompanyInfoCardWithYearSelector(
    title: String,              // 卡片标题（"财务状况"）
    currentYear: Int,           // 当前游戏年份
    selectedYear: Int,          // 选中的年份
    onYearChange: (Int) -> Unit, // 年份改变回调
    items: List<Pair<String, String>> // 财务数据项
)
```

### 数据计算流程

#### 1. 年份状态管理

```kotlin
var selectedFinancialYear by remember { mutableIntStateOf(currentYear) }
```

- 使用`remember`保持选择状态
- 默认值为当前游戏年份
- 支持动态更新

#### 2. 单机游戏收入计算

```kotlin
val startIndex = (selectedFinancialYear - 1) * 365
val endIndex = selectedFinancialYear * 365
val yearRevenue = revenue.dailySalesList
    .filterIndexed { index, _ -> index in startIndex until endIndex }
    .sumOf { it.revenue }
```

- 计算该年份在dailySalesList中的索引范围
- 筛选对应范围的数据
- 累加收入

#### 3. 网游收入计算

逻辑同单机游戏，分别计算后汇总。

#### 4. 总收入计算

```kotlin
val yearTotalRevenue = singlePlayerRevenue + onlineGameRevenue
```

### UI布局结构

```
CompanyInfoCardWithYearSelector
├── Box (背景容器)
│   └── Column (内容列)
│       ├── Row (标题行)
│       │   ├── Text (标题: "财务状况")
│       │   └── Box (下拉选择器)
│       │       ├── OutlinedButton (选择按钮)
│       │       └── DropdownMenu (下拉菜单)
│       │           └── DropdownMenuItem × N (年份选项)
│       └── Row × 3 (财务数据行)
│           ├── Text (标签)
│           └── Text (数值)
```

## 使用示例

### 示例场景

**游戏进行到第5年**

下拉菜单显示：
```
第5年 ← 当前选中（橙色高亮）
第4年
第3年
第2年
第1年
```

**切换到第3年**

财务状况显示：
- 单机收入：¥1,250,000（第3年所有单机游戏收入）
- 网游收入：¥3,500,000（第3年所有网游收入）
- 总收入：¥4,750,000（第3年总收入）

**切换到第1年**

财务状况显示：
- 单机收入：¥0（第1年可能还没发游戏）
- 网游收入：¥0
- 总收入：¥0

## 数据准确性

### 年份映射规则

| 游戏年份 | dailySalesList索引范围 | 天数范围 |
|---------|---------------------|---------|
| 第1年   | 0-364               | 1-365天  |
| 第2年   | 365-729             | 366-730天 |
| 第3年   | 730-1094            | 731-1095天 |
| 第N年   | (N-1)×365 ~ N×365-1 | ... |

### 边界情况处理

1. **游戏未满一年**
   - 只显示第1年选项
   - 计算实际天数的收入

2. **游戏未发售**
   - 收入显示为¥0.00

3. **年份跨度**
   - 如果dailySalesList不足365天，只计算已有数据
   - 不会报错或显示异常

## UI设计亮点

### 1. 视觉一致性

- 与原有CompanyInfoCard保持一致的设计风格
- 橙色标题主题色贯穿始终
- 半透明背景与界面融合

### 2. 交互反馈

- 选中项橙色高亮
- 悬停效果（DropdownMenu自带）
- 展开/折叠箭头方向变化

### 3. 信息层次

- 标题与选择器左右分布
- 选择器右对齐，不干扰标题阅读
- 数据行清晰对比

## 用户体验优化

### 1. 默认值智能化

- 自动显示当前年份
- 玩家无需额外操作即可看到最新数据

### 2. 年份倒序排列

- 最新年份在最上方
- 符合用户查看习惯（优先关注近期数据）

### 3. 即时更新

- 选择年份后立即更新数据
- 无需额外确认步骤
- 流畅的交互体验

## 扩展性

### 未来可扩展功能

1. **月度选择**
   - 在年份基础上增加月度筛选
   - 更精细的财务数据分析

2. **财务图表**
   - 添加折线图/柱状图
   - 可视化展示收入趋势

3. **同比/环比**
   - 显示与上一年的对比数据
   - 增长率百分比

4. **导出功能**
   - 导出财务报表
   - CSV或图片格式

5. **更多财务维度**
   - 支出明细（员工工资、服务器费用等）
   - 净利润
   - 现金流

## 测试建议

### 功能测试

1. **年份切换测试**
   - 切换到不同年份
   - 验证数据正确性

2. **边界值测试**
   - 第1年（游戏刚开始）
   - 当前年份
   - 中间任意年份

3. **数据准确性测试**
   - 对比手动计算结果
   - 验证索引范围是否正确

### UI测试

1. **下拉菜单测试**
   - 展开/折叠功能
   - 选中状态高亮
   - 年份列表完整性

2. **响应式测试**
   - 不同屏幕尺寸
   - 横屏/竖屏切换

3. **性能测试**
   - 50年以上的游戏
   - 大量游戏数据
   - 切换流畅度

## 修改文件

**MainActivity.kt**

1. **CompanyOverviewContent函数**
   - 添加selectedFinancialYear状态变量
   - 修改财务数据计算逻辑（按年份筛选）
   - 使用CompanyInfoCardWithYearSelector替代原CompanyInfoCard

2. **新增CompanyInfoCardWithYearSelector组件**
   - 完整的年份选择UI
   - 下拉菜单实现
   - 年份列表生成

## 兼容性

- ✅ 完全向后兼容
- ✅ 不影响现有存档
- ✅ 不需要数据库迁移
- ✅ 旧版本游戏自动适配

## 总结

财务状况年份选择功能为玩家提供了更灵活的财务数据查看方式，帮助玩家：

- 📊 回顾历史财务表现
- 📈 分析收入增长趋势
- 🎯 制定更好的经营策略
- 💰 了解不同阶段的收入结构

通过简洁直观的UI设计和准确的数据计算，提升了游戏的数据可视化体验。
