# 财务状况年份选择功能说明

## 功能概述

在公司概览界面的**财务状况**卡片右上角新增了年份选择按钮，点击后弹出居中对话框，玩家可以选择不同年份查看对应年份的财务数据。

## 核心功能

### 1. 年份选择对话框

**位置**：财务状况标题栏右侧

**功能**：
- 显示当前选择的年份（如"第3年"）
- 点击后弹出居中对话框
- 支持从第1年到当前游戏年份的所有年份选择
- 默认显示当前年份的数据

**UI特性**：
- 选择按钮样式：白色半透明背景，带边框，显示向下箭头▼
- 对话框背景：深色（#1F2937），圆角设计
- 对话框宽度：屏幕宽度的80%
- 对话框最大高度：400dp（支持滚动）
- 选中年份：橙色背景（半透明）+ 橙色文字 + 粗体
- 年份列表：使用LazyColumn实现，从最新年份到第1年倒序排列
- 底部关闭按钮：橙色按钮（#F59E0B）

### 2. 财务数据按年份统计

**统计维度**：
- **单机收入**：该年所有单机游戏的收入总和
- **网游收入**：该年所有网络游戏的收入总和
- **总收入**：单机收入 + 网游收入

**计算逻辑**：
- 每365天为一个游戏年度
- 第1年：第0-364天的数据
- 第2年：第365-729天的数据
- 第N年：第(N-1)×365 到 N×365-1天的数据

### 3. 实时切换

**交互流程**：
1. 玩家点击"第X年"按钮
2. 居中弹出对话框显示所有可选年份
3. 玩家点击目标年份或滚动列表查看更多年份
4. 选中年份后对话框自动关闭
5. 财务数据立即更新为所选年份的数据
6. 也可点击"关闭"按钮或对话框外区域关闭对话框

## 技术实现

### 核心组件

**CompanyInfoCardWithYearSelector**

新增的带年份选择器的公司信息卡片组件，包含以下参数：

```kotlin
@Composable
fun CompanyInfoCardWithYearSelector(
    title: String,              // 卡片标题（"财务状况"）
    currentYear: Int,           // 当前游戏年份
    selectedYear: Int,          // 选中的年份
    onYearChange: (Int) -> Unit, // 年份改变回调
    items: List<Pair<String, String>> // 财务数据项
)
```

### 数据计算流程

#### 1. 年份状态管理

```kotlin
var selectedFinancialYear by remember { mutableIntStateOf(currentYear) }
```

- 使用`remember`保持选择状态
- 默认值为当前游戏年份
- 支持动态更新

#### 2. 单机游戏收入计算

```kotlin
val startIndex = (selectedFinancialYear - 1) * 365
val endIndex = selectedFinancialYear * 365
val yearRevenue = revenue.dailySalesList
    .filterIndexed { index, _ -> index in startIndex until endIndex }
    .sumOf { it.revenue }
```

- 计算该年份在dailySalesList中的索引范围
- 筛选对应范围的数据
- 累加收入

#### 3. 网游收入计算

逻辑同单机游戏，分别计算后汇总。

#### 4. 总收入计算

```kotlin
val yearTotalRevenue = singlePlayerRevenue + onlineGameRevenue
```

### UI布局结构

```
CompanyInfoCardWithYearSelector
├── Box (背景容器)
│   └── Column (内容列)
│       ├── Row (标题行)
│       │   ├── Text (标题: "财务状况")
│       │   └── OutlinedButton (年份选择按钮)
│       ├── Dialog (年份选择对话框)
│       │   └── Box (对话框容器，80%宽度)
│       │       └── Column
│       │           ├── Text (对话框标题: "选择年份")
│       │           ├── LazyColumn (年份列表，最高400dp)
│       │           │   └── Box × N (年份项，可点击)
│       │           │       └── Text (年份文字)
│       │           └── Button (关闭按钮)
│       └── Row × 3 (财务数据行)
│           ├── Text (标签)
│           └── Text (数值)
```

## 使用示例

### 示例场景

**游戏进行到第5年**

点击"第5年"按钮后，对话框显示：
```
┌────────────────────┐
│   选择年份         │
├────────────────────┤
│ [第5年]  ← 橙色高亮│
│  第4年             │
│  第3年             │
│  第2年             │
│  第1年             │
├────────────────────┤
│   [关闭]           │
└────────────────────┘
```

**切换到第3年**

财务状况显示：
- 单机收入：¥1,250,000（第3年所有单机游戏收入）
- 网游收入：¥3,500,000（第3年所有网游收入）
- 总收入：¥4,750,000（第3年总收入）

**切换到第1年**

财务状况显示：
- 单机收入：¥0（第1年可能还没发游戏）
- 网游收入：¥0
- 总收入：¥0

## 数据准确性

### 年份映射规则

| 游戏年份 | dailySalesList索引范围 | 天数范围 |
|---------|---------------------|---------|
| 第1年   | 0-364               | 1-365天  |
| 第2年   | 365-729             | 366-730天 |
| 第3年   | 730-1094            | 731-1095天 |
| 第N年   | (N-1)×365 ~ N×365-1 | ... |

### 边界情况处理

1. **游戏未满一年**
   - 只显示第1年选项
   - 计算实际天数的收入

2. **游戏未发售**
   - 收入显示为¥0.00

3. **年份跨度**
   - 如果dailySalesList不足365天，只计算已有数据
   - 不会报错或显示异常

## UI设计亮点

### 1. 视觉一致性

- 与原有CompanyInfoCard保持一致的设计风格
- 橙色标题主题色贯穿始终（标题、选中项、关闭按钮）
- 半透明背景与界面融合
- 对话框深色背景（#1F2937）与整体风格统一

### 2. 交互反馈

- 选中年份：橙色半透明背景 + 橙色文字 + 粗体
- 点击年份项后对话框自动关闭
- 可点击对话框外区域或关闭按钮退出
- 流畅的动画效果（Dialog自带）

### 3. 信息层次

- 标题与选择器左右分布
- 选择器右对齐，不干扰标题阅读
- 数据行清晰对比
- 对话框居中显示，聚焦用户注意力

### 4. 响应式设计

- 对话框宽度：屏幕宽度的80%，适应不同屏幕
- LazyColumn支持滚动，最高400dp
- 长列表友好：年份较多时可流畅滚动
- 比下拉菜单更美观，不会超出屏幕

## 用户体验优化

### 1. 默认值智能化

- 自动显示当前年份
- 玩家无需额外操作即可看到最新数据

### 2. 年份倒序排列

- 最新年份在最上方
- 符合用户查看习惯（优先关注近期数据）

### 3. 即时更新

- 选择年份后立即更新数据
- 无需额外确认步骤
- 流畅的交互体验

## 扩展性

### 未来可扩展功能

1. **月度选择**
   - 在年份基础上增加月度筛选
   - 更精细的财务数据分析

2. **财务图表**
   - 添加折线图/柱状图
   - 可视化展示收入趋势

3. **同比/环比**
   - 显示与上一年的对比数据
   - 增长率百分比

4. **导出功能**
   - 导出财务报表
   - CSV或图片格式

5. **更多财务维度**
   - 支出明细（员工工资、服务器费用等）
   - 净利润
   - 现金流

## 测试建议

### 功能测试

1. **年份切换测试**
   - 切换到不同年份
   - 验证数据正确性

2. **边界值测试**
   - 第1年（游戏刚开始）
   - 当前年份
   - 中间任意年份

3. **数据准确性测试**
   - 对比手动计算结果
   - 验证索引范围是否正确

### UI测试

1. **对话框测试**
   - 对话框弹出/关闭功能
   - 选中状态高亮
   - 年份列表完整性
   - 点击对话框外区域关闭
   - 点击关闭按钮关闭
   - 点击年份后自动关闭

2. **响应式测试**
   - 不同屏幕尺寸（对话框80%宽度）
   - 横屏/竖屏切换
   - LazyColumn滚动流畅度

3. **性能测试**
   - 50年以上的游戏（长列表滚动）
   - 大量游戏数据
   - 切换流畅度
   - 对话框弹出动画流畅度

## 修改文件

**MainActivity.kt**

1. **CompanyOverviewContent函数**
   - 添加selectedFinancialYear状态变量
   - 修改财务数据计算逻辑（按年份筛选）
   - 使用CompanyInfoCardWithYearSelector替代原CompanyInfoCard

2. **新增CompanyInfoCardWithYearSelector组件**
   - 完整的年份选择UI
   - 使用Dialog实现居中弹出对话框
   - 使用LazyColumn实现可滚动年份列表
   - 年份项支持点击和高亮显示
   - 添加关闭按钮

## 兼容性

- ✅ 完全向后兼容
- ✅ 不影响现有存档
- ✅ 不需要数据库迁移
- ✅ 旧版本游戏自动适配

## 总结

财务状况年份选择功能为玩家提供了更灵活的财务数据查看方式，帮助玩家：

- 📊 回顾历史财务表现
- 📈 分析收入增长趋势
- 🎯 制定更好的经营策略
- 💰 了解不同阶段的收入结构

通过简洁直观的UI设计和准确的数据计算，提升了游戏的数据可视化体验。

### 对话框方案的优势

相比下拉菜单（DropdownMenu），居中弹出对话框（Dialog）具有以下优势：

1. **更美观**：居中显示，不会被屏幕边界裁切
2. **更友好**：长列表（10年以上）可流畅滚动，不会超出屏幕
3. **更聚焦**：对话框背景遮罩引导用户注意力
4. **更灵活**：对话框大小可自定义（80%宽度），适应不同屏幕
5. **更现代**：符合Material Design对话框设计规范

**适用场景**：
- ✅ 选项较多时（>5个）
- ✅ 需要更好的视觉层次
- ✅ 希望用户专注于选择操作
