# 子公司游戏财务状况修复说明

## 问题描述

用户反馈：收购子公司后，继承的网游有收入（收入报告显示正常），但在财务状况界面中，网游收入显示为¥0.00。

## 问题原因

子公司游戏的收入数据**没有正确计入财务状况**的分类统计，根本原因是**发售日期被覆盖**：

### 发售日期覆盖问题

1. **收购时**（第2086-2095行）：
   ```kotlin
   // 为继承的游戏初始化收益数据
   RevenueManager.generateRevenueData(
       gameId = inheritedGame.id,
       releaseYear = originalCompetitorGame.releaseYear,  // 使用竞争对手的发售年份（比如第1年1月）
       releaseMonth = originalCompetitorGame.releaseMonth,
       releaseDay = 1
   )
   ```

2. **手动发售时**（第2294-2303行，修复前）：
   ```kotlin
   // 重新初始化收益数据，发售日期被覆盖！
   RevenueManager.generateRevenueData(
       gameId = releasedGame.id,
       releaseYear = currentYear,  // 使用当前日期（比如第1年4月24日）
       releaseMonth = currentMonth,
       releaseDay = currentDay
   )
   ```

3. **问题后果**：
   - 收购后到发售前，游戏已经产生了日常收入数据（dailySalesList）
   - 这些收入数据的日期是从收购日到发售日（比如4月10日-4月23日）
   - 但发售时，发售日期被重置为4月24日
   - 财务状况计算时，使用4月24日作为基准，导致之前的收入数据（4月10-23日）被计算为"发售前"的数据，因此不计入
   - 结果：虽然有收入数据，但年份计算错误，财务状况显示为0

## 解决方案

修改手动发售逻辑，区分**普通游戏**和**子公司继承游戏**：

### 修改后的代码（第2293-2332行）

```kotlin
// 检查是否是子公司继承的游戏（ID以"inherited_"开头）
val isInheritedGame = releasedGame.id.startsWith("inherited_")

if (isInheritedGame) {
    // 子公司游戏：收益数据已在收购时初始化，只需更新价格和游戏信息
    val existingRevenue = RevenueManager.getGameRevenue(releasedGame.id)
    if (existingRevenue != null) {
        // 更新发售价格（保留原有的发售日期）✅
        RevenueManager.generateRevenueData(
            gameId = releasedGame.id,
            gameName = releasedGame.name,
            releasePrice = price.toDouble(),
            daysOnMarket = existingRevenue.daysOnMarket,
            releaseYear = existingRevenue.releaseYear,      // ✅ 保留原有发售年份
            releaseMonth = existingRevenue.releaseMonth,    // ✅ 保留原有发售月份
            releaseDay = existingRevenue.releaseDay,        // ✅ 保留原有发售日期
            promotionIndex = releasedGame.promotionIndex
        )
    }
} else {
    // 普通游戏：为已发售游戏初始化收益数据
    RevenueManager.generateRevenueData(
        gameId = releasedGame.id,
        releaseYear = currentYear,      // 使用当前日期
        releaseMonth = currentMonth,
        releaseDay = currentDay
    )
}
```

## 核心改进

1. ✅ **子公司游戏**：保留收购时的发售日期，只更新价格
2. ✅ **普通游戏**：使用当前日期初始化（原有逻辑）
3. ✅ **日志记录**：子公司游戏发售时会输出日志，便于调试

## 修复效果

- **收入报告**：正常显示子公司游戏的收入 ✅
- **财务状况**：网游收入正确计入财务状况统计 ✅
- **年份计算**：基于正确的发售日期，年份统计准确 ✅

## 测试建议

1. 收购一家有网游的子公司
2. 在项目管理中手动点击"发售"按钮
3. 等待几天，让游戏产生收入
4. 查看财务状况，网游收入应该正确显示

## 修改文件

- `MainActivity.kt` 第2293-2332行：游戏发售确认逻辑

## 向后兼容性

完全向后兼容，旧存档正常运行。对于已经发售的子公司游戏，如果出现财务状况显示不正确的问题，玩家需要：
1. 等待游戏继续运营几天
2. 财务状况会逐步累计新的收入数据

---

**修复时间**：2025-01-26
**修复版本**：待定
