# 竞争对手存档读档数据不一致问题修复说明

## 问题描述

用户发现存档前后的竞争对手数据不一致，特别是**热门网游排行榜**的数据：
- 活跃玩家数发生变化（有增有减）
- 总收入数据发生变化

**示例**（存档前 vs 读档后）：
- 史诗奇迹：55.66K/1.22M → 53.09K/1.61M
- 幻想奇迹：42.53K/2.24M → 30.81K/1.65M
- 战争重生：28.84K/1.57M → 19.02K/1.14M

## 问题根源

**核心原因：读档后时间推进系统立即启动，可能在短时间内触发月结算，导致竞争对手数据被更新一次。**

### 详细分析

1. **时间推进系统逻辑**（MainActivity.kt 第1227-1303行）：
   ```kotlin
   LaunchedEffect(gameSpeed, isPaused) {
       while (!isPaused) {
           delay(...) // 等待0.5-2秒
           currentDay++ // 日期+1
           if (currentDay > 30) {
               currentDay = 1
               currentMonth++
           }
           
           if (currentDay == 1) {
               // 触发月结算，更新竞争对手数据
               competitors = updatedCompetitors
           }
       }
   }
   ```

2. **问题场景重现**：
   - 用户在某月30号存档（currentDay = 30）
   - 读档后，时间推进系统立即启动
   - 延迟0.5-2秒后，执行`currentDay++` = 31
   - 因为31 > 30，所以`currentDay = 1`，`currentMonth++`
   - 检测到`currentDay == 1`，立即触发月结算
   - **竞争对手数据被更新一次**（活跃玩家±10%-30%，收入累加）

3. **为什么数据会变化**：
   - `updateCompetitors()`函数每月更新竞争对手数据：
     - 网游活跃玩家数：±10%-30%的随机波动
     - 网游总收入：累加本月付费内容收入
     - 单机游戏销量：+100-1000的增长
     - 单机游戏收入：累加新销量收入

## 解决方案

**添加月结算防重复机制**，记录上次月结算的年月，避免在同一个月内重复结算。

### 实现细节

1. **添加状态变量**（第1074-1076行）：
   ```kotlin
   // 上次月结算的年月（防止重复结算）
   var lastSettlementYear by remember { mutableIntStateOf(saveData?.currentYear ?: 1) }
   var lastSettlementMonth by remember { mutableIntStateOf(saveData?.currentMonth ?: 1) }
   ```

2. **修改月结算触发逻辑**（第1261-1308行）：
   ```kotlin
   if (currentDay == 1) {
       // 检查是否需要进行月结算（避免读档后重复结算）
       val needSettlement = (currentYear != lastSettlementYear || currentMonth != lastSettlementMonth)
       
       if (needSettlement) {
           // 执行月结算
           // ...
           
           // 更新上次月结算时间
           lastSettlementYear = currentYear
           lastSettlementMonth = currentMonth
       } else {
           Log.d("MainActivity", "⏭️ 跳过月结算（本月已结算）")
       }
   }
   ```

### 工作原理

1. **新游戏**：
   - `lastSettlementYear/Month`初始化为当前年月（1年1月）
   - 第一次进入2月1号时，年月发生变化，触发月结算
   - 更新`lastSettlementYear/Month`为2月
   - 以后每月都正常结算

2. **读档**：
   - `lastSettlementYear/Month`初始化为存档的年月
   - 如果存档时是5月10号，读档后立即变成5月11号
   - 即使后续变成6月1号，也会检测到年月变化（5月→6月），正常触发月结算
   - **关键点**：如果在5月1号读档，即使时间推进让日期从1号变成2号再变回1号，因为月份没变，也不会触发月结算

3. **防止重复结算**：
   - 只有当`currentYear`或`currentMonth`与`lastSettlementYear/Month`不同时才触发
   - 确保同一个月只会结算一次

## 影响范围

### 修复的问题
- ✅ 竞争对手网游活跃玩家数不会在读档后立即变化
- ✅ 竞争对手总收入不会在读档后立即累加
- ✅ 竞争对手单机游戏销量不会在读档后立即增长
- ✅ 所有排行榜（市值、粉丝、热门网游、畅销单机）数据保持一致

### 相关排行榜
所有排行榜都是基于`saveData.competitors`的数据计算的，只要竞争对手数据不被重复更新，所有排行榜都会保持一致：

1. **市值排行榜**：基于`company.marketValue`（由总收入、评分、年数计算）
2. **粉丝排行榜**：基于`company.fans`
3. **热门网游排行榜**：基于`game.activePlayers`和`game.totalRevenue`
4. **畅销单机排行榜**：基于`game.salesCount`和`game.totalRevenue`

## 测试验证

### 测试步骤
1. 在游戏中运行一段时间，让竞争对手有一定数据
2. 在任意日期（特别是月末）保存游戏
3. 立即读档
4. 查看竞争对手排行榜数据
5. 验证数据与存档前完全一致

### 预期结果
- 读档后，竞争对手数据应与存档前完全一致
- 只有当游戏时间真正推进到下个月1号时，才会触发月结算
- 日志中会显示"⏭️ 跳过月结算（本月已结算）"或"🗓️ 触发月结算"

## 其他注意事项

1. **向后兼容**：
   - 旧存档加载时，`lastSettlementYear/Month`会自动初始化为存档的当前年月
   - 不会影响现有存档的正常使用

2. **不影响正常游戏流程**：
   - 只是防止重复结算，不改变月结算的触发条件
   - 游戏时间正常推进时，每月1号仍会正常触发月结算

3. **日志监控**：
   - 添加了详细的日志输出，方便调试和追踪月结算行为
   - 可以通过Logcat查看"🗓️ 触发月结算"和"⏭️ 跳过月结算"日志

## 修改文件

- `MainActivity.kt`：
  - 第1074-1076行：添加`lastSettlementYear`和`lastSettlementMonth`状态变量
  - 第1261-1308行：修改月结算触发逻辑，添加防重复检查

## 版本信息

- 修复日期：2025-01-20
- 涉及版本：V1.8.1+
- Bug严重程度：中等（影响数据一致性，但不影响游戏进程）
