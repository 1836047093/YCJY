package com.example.yjcy.data

import java.text.SimpleDateFormat
import java.util.Date
import java.util.Locale

/**
 * èŠå¤©æ¶ˆæ¯å‘é€è€…ç±»å‹
 */
enum class MessageSender {
    SECRETARY,  // ç§˜ä¹¦
    PLAYER      // ç©å®¶
}

/**
 * èŠå¤©æ¶ˆæ¯æ•°æ®ç±»
 */
data class ChatMessage(
    val id: String = generateMessageId(),
    val sender: MessageSender,
    val content: String,
    val timestamp: Long = System.currentTimeMillis()
) {
    companion object {
        private var messageCounter = 0
        
        fun generateMessageId(): String {
            return "msg_${System.currentTimeMillis()}_${messageCounter++}"
        }
    }
    
    /**
     * è·å–æ ¼å¼åŒ–çš„æ—¶é—´æˆ³
     */
    fun getFormattedTime(): String {
        val sdf = SimpleDateFormat("HH:mm", Locale.getDefault())
        return sdf.format(Date(timestamp))
    }
}

/**
 * ç§˜ä¹¦è‡ªåŠ¨å›å¤ç®¡ç†å™¨ï¼ˆæ™ºèƒ½ç‰ˆï¼‰
 */
object SecretaryReplyManager {
    
    // æ¬¢è¿æ¶ˆæ¯
    const val WELCOME_MESSAGE = "è€æ¿ï¼Œæ‚¨å¥½ï¼"
    
    // ========== æ•æ„Ÿè¯è¿‡æ»¤ç³»ç»Ÿ ==========
    
    // å›½å®¶é¢†å¯¼äººå’Œæ”¿æ²»äººç‰©ï¼ˆä¸­å›½ï¼‰
    private val politicalFigures = listOf(
        "ä¹ è¿‘å¹³", "æå¼º", "èµµä¹é™…", "ç‹æ²ªå®", "è”¡å¥‡", "ä¸è–›ç¥¥", "æå¸Œ",
        "æ¯›æ³½ä¸œ", "é‚“å°å¹³", "æ±Ÿæ³½æ°‘", "èƒ¡é”¦æ¶›", "å‘¨æ©æ¥", "æœ±é••åŸº",
        "æ¸©å®¶å®", "æå…‹å¼º", "æé¹", "ä¹ ä»²å‹‹", "å½­ä¸½åª›",
        "ä¸»å¸­", "æ€»ä¹¦è®°", "æ€»ç†", "æ”¿æ²»å±€", "å¸¸å§”"
    )
    
    // å›½é™…æ”¿æ²»äººç‰©
    private val internationalFigures = listOf(
        "ç‰¹æœ—æ™®", "æ‹œç™»", "æ™®äº¬", "é‡‘æ­£æ©", "æ–‡åœ¨å¯…", "å²¸ç”°æ–‡é›„",
        "é©¬å…‹é¾™", "é»˜å…‹å°”", "çº¦ç¿°é€Š", "å¥¥å·´é©¬", "å…‹æ—é¡¿", "å¸ƒä»€"
    )
    
    // æ•æ„Ÿæ”¿æ²»è¯æ±‡
    private val politicalTerms = listOf(
        "å…±äº§å…š", "å›½æ°‘å…š", "æ°‘è¿›å…š", "æ³•è½®åŠŸ", "å…­å››", "å¤©å®‰é—¨",
        "å°ç‹¬", "è—ç‹¬", "ç–†ç‹¬", "æ¸¯ç‹¬", "æ°‘ä¸»", "è‡ªç”±", "äººæƒ",
        "æ”¿å˜", "é©å‘½", "èµ·ä¹‰", "æš´åŠ¨", "æ¸¸è¡Œ", "ç¤ºå¨"
    )
    
    // ç»¼åˆæ•æ„Ÿè¯åˆ—è¡¨
    private val sensitiveWords = politicalFigures + internationalFigures + politicalTerms
    
    /**
     * æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦åŒ…å«æ•æ„Ÿè¯
     */
    fun containsSensitiveWords(message: String): Boolean {
        return sensitiveWords.any { sensitive ->
            message.contains(sensitive, ignoreCase = true)
        }
    }
    
    // ========== æ™ºèƒ½å›å¤ç³»ç»Ÿ ==========
    
    // é—®å€™ç±»
    private val greetingPatterns = mapOf(
        listOf("ä½ å¥½", "æ‚¨å¥½", "hi", "hello") to listOf(
            "æ‚¨å¥½ï¼Œè€æ¿ï¼æœ‰ä»€ä¹ˆéœ€è¦æˆ‘å¸®å¿™çš„å—ï¼Ÿ",
            "è€æ¿å¥½ï¼å¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ï¼",
            "æ‚¨å¥½ï¼æˆ‘éšæ—¶å¾…å‘½ï¼"
        ),
        listOf("æ—©ä¸Šå¥½", "æ—©å®‰", "æ—©") to listOf(
            "æ—©ä¸Šå¥½ï¼Œè€æ¿ï¼æ–°çš„ä¸€å¤©ï¼Œè®©æˆ‘ä»¬ä¸€èµ·åŠ æ²¹ï¼",
            "æ—©å®‰ï¼ç¥è€æ¿ä»Šå¤©å·¥ä½œé¡ºåˆ©ï¼"
        ),
        listOf("ä¸­åˆå¥½", "åˆå®‰") to listOf(
            "ä¸­åˆå¥½ï¼Œè€æ¿ï¼è®°å¾—åƒåˆé¥­å“¦ï¼",
            "åˆå®‰ï¼å·¥ä½œè¾›è‹¦äº†ï¼Œä¼‘æ¯ä¸€ä¸‹å§ï¼"
        ),
        listOf("æ™šä¸Šå¥½", "æ™šå®‰", "æ™š") to listOf(
            "æ™šä¸Šå¥½ï¼Œè€æ¿ï¼ä»Šå¤©è¾›è‹¦äº†ï¼",
            "æ™šå®‰ï¼Œè€æ¿ï¼å¥½å¥½ä¼‘æ¯ï¼Œæ˜å¤©è§ï¼"
        ),
        listOf("å†è§", "æ‹œæ‹œ", "88", "bye") to listOf(
            "å†è§ï¼Œè€æ¿ï¼ç¥æ‚¨å·¥ä½œé¡ºåˆ©ï¼",
            "æ‹œæ‹œï¼Œè€æ¿ï¼éšæ—¶æ‰¾æˆ‘å“¦ï¼"
        )
    )
    
    // è¯¢é—®çŠ¶æ€ç±»ï¼ˆéœ€è¦ç²¾ç¡®åŒ¹é…ä»¥é¿å…è¯¯åˆ¤ï¼‰
    private val statusPatterns = mapOf(
        listOf("ä½ å¥½å—", "æ€ä¹ˆæ ·", "æœ€è¿‘å¦‚ä½•", "è¿‡å¾—æ€æ ·") to listOf(
            "æˆ‘å¾ˆå¥½ï¼Œè°¢è°¢è€æ¿å…³å¿ƒï¼æ‚¨å‘¢ï¼Ÿ",
            "ä¸€åˆ‡éƒ½å¥½ï¼Œéšæ—¶å‡†å¤‡ä¸ºæ‚¨æœåŠ¡ï¼",
            "å¾ˆå¥½ï¼èƒ½ä¸ºè€æ¿å·¥ä½œæˆ‘å¾ˆå¼€å¿ƒï¼"
        ),
        listOf("åœ¨å—", "åœ¨ä¸åœ¨", "æœ‰äººå—") to listOf(
            "åœ¨çš„ï¼Œè€æ¿ï¼æœ‰ä»€ä¹ˆå©å’ï¼Ÿ",
            "æˆ‘ä¸€ç›´éƒ½åœ¨ï¼éœ€è¦å¸®å¿™å—ï¼Ÿ"
        )
    )
    
    // æ„Ÿè°¢ç±»
    private val thanksPatterns = mapOf(
        listOf("è°¢è°¢", "æ„Ÿè°¢", "è¾›è‹¦äº†", "thanks") to listOf(
            "ä¸å®¢æ°”ï¼Œè€æ¿ï¼è¿™æ˜¯æˆ‘åº”è¯¥åšçš„ã€‚",
            "ä¸ºæ‚¨æœåŠ¡æ˜¯æˆ‘çš„è£å¹¸ï¼",
            "ä¸ç”¨è°¢ï¼å¾ˆé«˜å…´èƒ½å¸®åˆ°æ‚¨ï¼"
        )
    )
    
    // èµç¾ç±»
    private val praisePatterns = mapOf(
        listOf("æ¼‚äº®", "ç¾å¥³", "å¥½çœ‹", "ç¾") to listOf(
            "è°¢è°¢å¤¸å¥–ï¼Œè€æ¿ï¼ğŸ’•",
            "æ‚¨çœŸä¼šè¯´è¯ï¼ğŸ˜Š"
        ),
        listOf("å¯çˆ±", "èŒ") to listOf(
            "æ‚¨çœŸä¼šè¯´è¯ï¼ğŸ˜Š",
            "è°¢è°¢è€æ¿ï¼æ‚¨ä¹Ÿå¾ˆå¯çˆ±å‘¢ï¼"
        ),
        listOf("èªæ˜", "å‰å®³", "èƒ½å¹²", "ä¼˜ç§€") to listOf(
            "è¿™éƒ½æ˜¯è·Ÿè€æ¿æ‚¨å­¦çš„ï¼",
            "è€æ¿æ‰æ˜¯æœ€å‰å®³çš„ï¼",
            "ä¸ºæ‚¨åˆ†å¿§æ˜¯æˆ‘çš„èŒè´£ï¼"
        )
    )
    
    // å·¥ä½œç›¸å…³ç±»
    private val workPatterns = mapOf(
        listOf("å…¬å¸", "ä¼ä¸š", "å·¥ä½œå®¤") to listOf(
            "å’±ä»¬å…¬å¸æ­£åœ¨è“¬å‹ƒå‘å±•ä¸­ï¼",
            "å…¬å¸ä¸šåŠ¡è’¸è’¸æ—¥ä¸Šï¼Œè€æ¿è‹±æ˜ï¼"
        ),
        listOf("æ¸¸æˆ", "é¡¹ç›®", "å¼€å‘") to listOf(
            "æ¸¸æˆå¼€å‘è¿›å±•é¡ºåˆ©ï¼Œè€æ¿ï¼",
            "é¡¹ç›®ä¸€åˆ‡éƒ½åœ¨æŒ‰è®¡åˆ’æ¨è¿›ï¼"
        ),
        listOf("å‘˜å·¥", "äººå‘˜", "å›¢é˜Ÿ") to listOf(
            "å‘˜å·¥ä»¬éƒ½å¾ˆåŠªåŠ›å·¥ä½œå‘¢ï¼",
            "å›¢é˜Ÿå£«æ°”é«˜æ¶¨ï¼Œå¤§å®¶å¹²åŠ²åè¶³ï¼"
        ),
        listOf("èµ„é‡‘", "é’±", "æ”¶å…¥", "æ”¶ç›Š") to listOf(
            "è®©æˆ‘æŸ¥çœ‹ä¸€ä¸‹è´¢åŠ¡æ•°æ®...",
            "æ”¶ç›Šæ•°æ®çœ‹èµ·æ¥ä¸é”™ï¼Œè€æ¿ï¼"
        ),
        listOf("é”€é‡", "é”€å”®", "å–") to listOf(
            "æœ€è¿‘çš„é”€é‡è¡¨ç°å¾ˆå¥½ï¼",
            "é”€å”®æ•°æ®ç¨³æ­¥å¢é•¿ä¸­ï¼"
        )
    )
    
    // å›ç­”æ€§é™ˆè¿°å¥ï¼ˆå¯¹ç§˜ä¹¦åé—®çš„å›ç­”ï¼‰- æœ€é«˜ä¼˜å…ˆçº§
    private val answerPatterns = mapOf(
        // åƒé¥­çŠ¶æ€å›ç­”
        listOf("åƒäº†", "æˆ‘åƒäº†", "åƒè¿‡äº†", "æˆ‘åƒè¿‡äº†", "å·²ç»åƒäº†", "åˆšåƒå®Œ") to listOf(
            "é‚£å°±å¥½ï¼è®°å¾—æŒ‰æ—¶åƒé¥­å¯¹èº«ä½“å¥½ï¼",
            "å¥½çš„ï¼Œæ³¨æ„è¥å…»å‡è¡¡å“¦ï¼Œè€æ¿ï¼",
            "å—¯å—¯ï¼Œåƒé¥±äº†æ‰æœ‰åŠ›æ°”å·¥ä½œï¼"
        ),
        listOf("æ²¡åƒ", "æˆ‘æ²¡åƒ", "è¿˜æ²¡åƒ", "æˆ‘è¿˜æ²¡åƒ", "æ²¡æœ‰", "è¿˜æ²¡") to listOf(
            "é‚£èµ¶ç´§å»åƒå§ï¼Œè€æ¿ï¼åˆ«é¥¿åäº†ï¼",
            "è¦æŒ‰æ—¶åƒé¥­å“¦ï¼Œèº«ä½“æœ€é‡è¦ï¼",
            "å¿«å»åƒå§ï¼Œå·¥ä½œå¯ä»¥ç­‰ä¸€ç­‰ï¼"
        ),
        // çŠ¶æ€å›ç­”ï¼ˆç´¯ã€é¥¿ç­‰ï¼‰
        listOf("ç´¯äº†", "æˆ‘ç´¯äº†", "æœ‰ç‚¹ç´¯", "å¾ˆç´¯") to listOf(
            "é‚£å°±ä¼‘æ¯ä¸€ä¸‹å§ï¼Œè€æ¿ï¼",
            "è¾›è‹¦äº†ï¼Œæ³¨æ„åŠ³é€¸ç»“åˆï¼",
            "ç´¯äº†å°±æ­‡ä¼šå„¿ï¼Œåˆ«å¤ªæ‹¼ï¼"
        ),
        listOf("ä¸ç´¯", "æˆ‘ä¸ç´¯", "è¿˜å¥½", "è¿˜è¡Œ") to listOf(
            "é‚£å°±å¥½ï¼ç»§ç»­åŠ æ²¹ï¼",
            "å—¯å—¯ï¼Œä¿æŒå¥½çŠ¶æ€ï¼",
            "å¥½çš„ï¼Œæœ‰éœ€è¦éšæ—¶å«æˆ‘ï¼"
        ),
        listOf("é¥¿äº†", "æˆ‘é¥¿äº†", "æœ‰ç‚¹é¥¿") to listOf(
            "é‚£å¿«å»åƒä¸œè¥¿å§ï¼Œè€æ¿ï¼",
            "åˆ«é¥¿ç€ï¼Œå¿«å»åƒé¥­ï¼",
            "è¦åŠæ—¶è¡¥å……èƒ½é‡å“¦ï¼"
        ),
        listOf("ä¸é¥¿", "æˆ‘ä¸é¥¿", "åƒé¥±äº†") to listOf(
            "é‚£å°±å¥½ï¼",
            "å—¯å—¯ï¼Œåƒé¥±äº†å°±å¥½ï¼"
        )
    )
    
    // å…³å¿ƒç±» - é™ˆè¿°å¥ï¼ˆä¸å«ç–‘é—®è¯ï¼‰
    private val carePatterns = mapOf(
        listOf("å»åƒé¥­", "æƒ³åƒé¥­") to listOf(
            "å¥½çš„ï¼Œè®°å¾—æŒ‰æ—¶åƒé¥­å“¦ï¼Œè€æ¿ï¼",
            "è¦å¥½å¥½åƒé¥­ï¼Œèº«ä½“æ‰æ˜¯æœ¬é’±ï¼"
        ),
        listOf("å»ä¼‘æ¯", "æƒ³ä¼‘æ¯", "å»ç¡è§‰", "æƒ³ç¡è§‰") to listOf(
            "å¥½çš„ï¼Œæ³¨æ„åŠ³é€¸ç»“åˆå“¦ï¼Œè€æ¿ï¼",
            "å·¥ä½œä¹‹ä½™ä¹Ÿè¦å¥½å¥½ä¼‘æ¯ï¼",
            "æ‚¨è¾›è‹¦äº†ï¼Œå»ä¼‘æ¯ä¸€ä¸‹å§ï¼"
        ),
        listOf("å¥½å¿™", "å¾ˆå¤šäº‹") to listOf(
            "æ‚¨è¾›è‹¦äº†ï¼Œè€æ¿ï¼éœ€è¦æˆ‘å¸®å¿™å—ï¼Ÿ",
            "åˆ«å¤ªç´¯äº†ï¼Œæœ‰ä»€ä¹ˆéœ€è¦æˆ‘åšçš„å°½ç®¡è¯´ï¼"
        )
    )
    
    // è¯¢é—®å¼é—®å¥ï¼ˆåŒ…å«ç–‘é—®è¯ï¼‰
    private val questionPatterns = mapOf(
        // åƒé¥­ç›¸å…³è¯¢é—®
        listOf("åƒé¥­äº†å—", "åƒé¥­æ²¡", "åƒäº†å—", "åƒäº†æ²¡", "åƒè¿‡äº†å—") to listOf(
            "åƒè¿‡äº†ï¼Œè°¢è°¢è€æ¿å…³å¿ƒï¼æ‚¨åƒäº†å—ï¼Ÿ",
            "è¿˜æ²¡å‘¢ï¼Œå¾…ä¼šå„¿å»åƒï¼è€æ¿æ‚¨å‘¢ï¼Ÿ",
            "åˆšåƒå®Œï¼è€æ¿æ‚¨åƒäº†å—ï¼Ÿ"
        ),
        // ä¸€èˆ¬çŠ¶æ€è¯¢é—®ï¼ˆé¥¿ã€ç´¯ç­‰ï¼‰
        listOf("é¥¿ä¸é¥¿", "é¥¿å—", "é¥¿äº†å—") to listOf(
            "æœ‰ç‚¹é¥¿äº†å‘¢ï¼Œè€æ¿ï¼",
            "è¿˜å¥½ï¼Œä¸å¤ªé¥¿ï¼æ‚¨å‘¢ï¼Ÿ"
        ),
        listOf("ç´¯ä¸ç´¯", "ç´¯å—", "ç´¯äº†å—", "å›°ä¸å›°", "å›°å—") to listOf(
            "è¿˜å¥½ï¼Œä¸ç´¯ï¼è°¢è°¢è€æ¿å…³å¿ƒï¼",
            "æœ‰ä¸€ç‚¹ç´¯äº†ï¼Œä½†è¿˜èƒ½åšæŒï¼",
            "ä¸ç´¯ï¼ä¸ºè€æ¿å·¥ä½œæˆ‘å¾ˆå¼€å¿ƒï¼"
        ),
        listOf("å¿™ä¸å¿™", "å¿™å—", "å¿™ç€å—") to listOf(
            "è¿˜å¥½ï¼Œä¸ç®—å¤ªå¿™ï¼",
            "æœ‰ç‚¹å¿™ï¼Œä½†éƒ½èƒ½å¤„ç†å¥½ï¼"
        ),
        // å·¥ä½œç›¸å…³è¯¢é—®
        listOf("æ¸¸æˆæ€ä¹ˆæ ·", "é¡¹ç›®æ€ä¹ˆæ ·", "å¼€å‘å¾—æ€æ ·") to listOf(
            "æ¸¸æˆå¼€å‘è¿›å±•é¡ºåˆ©ï¼Œè€æ¿ï¼",
            "é¡¹ç›®ä¸€åˆ‡éƒ½åœ¨æŒ‰è®¡åˆ’æ¨è¿›ï¼"
        ),
        listOf("å…¬å¸æ€ä¹ˆæ ·", "å…¬å¸å¦‚ä½•") to listOf(
            "å’±ä»¬å…¬å¸æ­£åœ¨è“¬å‹ƒå‘å±•ä¸­ï¼",
            "å…¬å¸ä¸šåŠ¡è’¸è’¸æ—¥ä¸Šï¼Œè€æ¿è‹±æ˜ï¼"
        ),
        listOf("å‘˜å·¥æ€ä¹ˆæ ·", "å›¢é˜Ÿæ€ä¹ˆæ ·") to listOf(
            "å‘˜å·¥ä»¬éƒ½å¾ˆåŠªåŠ›å·¥ä½œå‘¢ï¼",
            "å›¢é˜Ÿå£«æ°”é«˜æ¶¨ï¼Œå¤§å®¶å¹²åŠ²åè¶³ï¼"
        ),
        listOf("èµ„é‡‘æ€ä¹ˆæ ·", "æ”¶ç›Šæ€ä¹ˆæ ·", "é”€é‡æ€ä¹ˆæ ·") to listOf(
            "è®©æˆ‘æŸ¥çœ‹ä¸€ä¸‹æ•°æ®...",
            "æ•°æ®çœ‹èµ·æ¥ä¸é”™ï¼Œè€æ¿ï¼"
        )
    )
    
    // æƒ…æ„Ÿç±»
    private val emotionPatterns = mapOf(
        listOf("å–œæ¬¢", "çˆ±", "love") to listOf(
            "æˆ‘ä¹Ÿå¾ˆå–œæ¬¢ä¸ºæ‚¨å·¥ä½œï¼",
            "èƒ½å¾—åˆ°è€æ¿çš„è®¤å¯çœŸæ˜¯å¤ªå¥½äº†ï¼"
        ),
        listOf("åŠ æ²¹", "åŠªåŠ›", "å¥‹æ–—") to listOf(
            "æ‚¨ä¹ŸåŠ æ²¹ï¼Œè€æ¿ï¼æˆ‘ä»¬ä¸€èµ·åŠªåŠ›ï¼",
            "æ˜¯çš„ï¼è®©æˆ‘ä»¬ä¸€èµ·åŠ æ²¹ï¼"
        ),
        listOf("å“ˆå“ˆ", "å‘µå‘µ", "ç¬‘") to listOf(
            "çœ‹åˆ°è€æ¿å¼€å¿ƒæˆ‘ä¹Ÿå¾ˆé«˜å…´ï¼ğŸ˜Š",
            "æ‚¨çš„ç¬‘å®¹æœ€ç¾äº†ï¼"
        )
    )
    
    // å…œåº•å›å¤ï¼ˆå½“æ— æ³•åŒ¹é…ä»»ä½•æ¨¡å¼æ—¶ä½¿ç”¨ï¼‰
    private val fallbackReplies = listOf(
        "è€æ¿ï¼Œæ‚¨è¯´ä»€ä¹ˆï¼Ÿæˆ‘æ²¡å¤ªå¬æ‡‚...",
        "æŠ±æ­‰ï¼Œæˆ‘ä¸å¤ªç†è§£æ‚¨çš„æ„æ€ï¼Œèƒ½å†è¯´æ¸…æ¥šä¸€ç‚¹å—ï¼Ÿ",
        "å—¯...è¿™ä¸ªé—®é¢˜æˆ‘éœ€è¦æƒ³ä¸€æƒ³...",
        "æ‚¨èƒ½è¯¦ç»†è¯´æ˜ä¸€ä¸‹å—ï¼Ÿ",
        "æˆ‘å¥½åƒä¸å¤ªæ˜ç™½ï¼Œæ‚¨æ˜¯åœ¨è¯¢é—®å·¥ä½œä¸Šçš„äº‹æƒ…å—ï¼Ÿ"
    )
    
    /**
     * æ ¹æ®ç©å®¶æ¶ˆæ¯ç”Ÿæˆæ™ºèƒ½å›å¤
     */
    fun generateReply(playerMessage: String): String {
        val message = playerMessage.trim()
        
        // 1. é¦–å…ˆæ£€æŸ¥æ•æ„Ÿè¯
        if (containsSensitiveWords(message)) {
            return "âš ï¸ æ£€æµ‹åˆ°æ•æ„Ÿè¯ï¼Œè¯·ä¸è¦è®¨è®ºæ”¿æ²»ç›¸å…³è¯é¢˜å“¦ï¼Œè€æ¿ï¼"
        }
        
        // 2. ç©ºæ¶ˆæ¯å¤„ç†
        if (message.isEmpty()) {
            return "è€æ¿ï¼Œæ‚¨æƒ³è¯´ä»€ä¹ˆå‘¢ï¼Ÿ"
        }
        
        // 3. ã€æœ€é«˜ä¼˜å…ˆçº§ã€‘å›ç­”æ€§é™ˆè¿°å¥ï¼ˆå¯¹ç§˜ä¹¦åé—®çš„å›ç­”ï¼‰
        // å¿…é¡»ä¼˜å…ˆäºç–‘é—®å¥åˆ¤æ–­ï¼Œå› ä¸º"æ²¡åƒ"ã€"è¿˜æ²¡"ç­‰åŒ…å«"æ²¡"å­—ä½†ä¸æ˜¯ç–‘é—®å¥
        for ((keywords, replies) in answerPatterns) {
            if (keywords.any { keyword -> message.contains(keyword, ignoreCase = true) }) {
                return replies.random()
            }
        }
        
        // 4. ã€æ¬¡é«˜ä¼˜å…ˆçº§ã€‘ç–‘é—®å¥ç²¾ç¡®åŒ¹é…ï¼ˆé¿å…å’Œé™ˆè¿°å¥æ··æ·†ï¼‰
        // æ£€æµ‹ç–‘é—®è¯ï¼šå—ã€æ²¡ã€å‘¢ã€ä¸ã€å¦‚ä½•ã€æ€æ ·ã€æ€ä¹ˆæ ·
        val isQuestion = message.contains("å—") || message.contains("æ²¡") || 
                        message.contains("å‘¢") || message.contains("?") || message.contains("ï¼Ÿ") ||
                        message.contains("æ€ä¹ˆæ ·") || message.contains("å¦‚ä½•") || message.contains("æ€æ ·")
        
        if (isQuestion) {
            // å…ˆåŒ¹é…å…·ä½“çš„é—®å¥æ¨¡å¼
            for ((keywords, replies) in questionPatterns) {
                if (keywords.any { keyword -> message.contains(keyword, ignoreCase = true) }) {
                    return replies.random()
                }
            }
            
            // å¦‚æœæ˜¯é—®å¥ä½†æ²¡åŒ¹é…åˆ°å…·ä½“æ¨¡å¼ï¼Œè¿”å›é€šç”¨é—®å¥å›å¤
            return listOf(
                "è¿™ä¸ªé—®é¢˜è®©æˆ‘æƒ³æƒ³...",
                "å—¯...æ‚¨é—®çš„è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘è§‰å¾—...",
                "å…³äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘å»ºè®®æ‚¨æŸ¥çœ‹ç›¸å…³æ•°æ®ï¼",
                "æŠ±æ­‰ï¼Œè¿™ä¸ªæˆ‘ä¸å¤ªæ¸…æ¥šï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹æ¸¸æˆç•Œé¢ï¼"
            ).random()
        }
        
        // 5. é™ˆè¿°å¥æ¨¡å¼åŒ¹é…ï¼šé—®å€™ > è¯¢é—®çŠ¶æ€ > æ„Ÿè°¢ > èµç¾ > å·¥ä½œ > å…³å¿ƒ > æƒ…æ„Ÿ
        val allPatterns = listOf(
            greetingPatterns,
            statusPatterns,
            thanksPatterns,
            praisePatterns,
            workPatterns,
            carePatterns,
            emotionPatterns
        )
        
        // éå†æ‰€æœ‰æ¨¡å¼ï¼Œæ‰¾åˆ°æœ€åŒ¹é…çš„å›å¤
        for (patterns in allPatterns) {
            for ((keywords, replies) in patterns) {
                // æ£€æŸ¥æ˜¯å¦åŒ…å«ä»»ä½•å…³é”®è¯
                if (keywords.any { keyword -> message.contains(keyword, ignoreCase = true) }) {
                    return replies.random()
                }
            }
        }
        
        // 6. ç‰¹æ®Šæ ‡ç‚¹ç¬¦å·å¤„ç†ï¼ˆæ„Ÿå¹å·ï¼‰
        if (message.contains("!") || message.contains("ï¼")) {
            return listOf(
                "æ˜¯çš„ï¼",
                "å¤ªå¥½äº†ï¼",
                "æ²¡é”™ï¼",
                "æˆ‘ä¹Ÿè¿™ä¹ˆè§‰å¾—ï¼"
            ).random()
        }
        
        // 7. å¦‚æœéƒ½æ²¡åŒ¹é…ä¸Šï¼Œè¿”å›å…œåº•å›å¤
        return fallbackReplies.random()
    }
}
